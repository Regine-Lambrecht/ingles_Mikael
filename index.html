<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastery Quiz</title>
    <style>
        /* --- CSS STYLES (Mobile-First Responsive Design) --- */
        :root {
            --color-primary: #3498db;
            --color-secondary: #2ecc71;
            --color-wrong: #e74c3c;
            --color-bg: #ecf0f1;
            --color-text: #2c3e50;
            --color-light-text: #fefefe;
            --color-gray: #bdc3c7;
        }

        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-bg);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #app {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            box-sizing: border-box;
            background-color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative; /* Needed for absolute positioning of exit button */
        }

        /* --- Screens --- */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .screen.active {
            display: flex;
        }

        /* --- Login Screen --- */
        #login-screen input[type="text"],
        #login-screen button {
            padding: 10px;
            margin: 10px 0;
            width: 100%;
            max-width: 300px;
            box-sizing: border-box;
            border-radius: 5px;
        }
        #login-screen input[type="text"] {
            border: 1px solid var(--color-gray);
        }
        #login-screen button {
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            cursor: pointer;
        }

        /* --- Home Screen --- */
        .home-title {
            color: var(--color-primary);
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        .theme-button {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .theme-button:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .theme-button:disabled {
            background-color: var(--color-gray);
            cursor: not-allowed;
        }
        .medium-button, .expert-button {
            background-color: var(--color-secondary);
        }
        .medium-button:hover:not(:disabled), .expert-button:hover:not(:disabled) {
            background-color: #27ae60;
        }
        .advanced-button {
            background-color: #8e44ad; /* Purple for Advanced */
        }
        .advanced-button:hover:not(:disabled) {
            background-color: #793397;
        }

        /* --- Quiz Screen / Feedback Screen Common --- */
        .exit-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--color-wrong);
            z-index: 10;
        }
        #question-screen h3 {
            margin-bottom: 0;
        }
        #question-image {
            max-width: 90%;
            max-height: 200px;
            width: auto;
            height: auto;
            margin: 20px 0;
            border: 1px solid var(--color-gray);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* Anagram Game Specific Styles */
        .answer-slots, .letter-choices {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 10px 0;
            gap: 5px;
        }
        .letter-slot {
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-bottom: 2px solid var(--color-text);
            margin: 0 2px;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-text);
        }
        .letter-button {
            padding: 8px 12px;
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 2px;
        }
        .letter-button:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .letter-button:disabled {
            background-color: var(--color-gray);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Standard Choice Buttons (Used for New/Medium levels) */
        .choice-button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .choice-button:hover {
            background-color: #2980b9;
        }
        /* End Anagram Game Specific Styles */

        #timer-bar {
            width: 100%;
            height: 10px;
            background-color: var(--color-wrong);
            transition: width 0.1s linear;
            margin-bottom: 15px;
        }
        .timer-container {
            width: 100%;
            background-color: var(--color-gray);
            margin-bottom: 10px;
            border-radius: 5px;
            overflow: hidden;
        }

        /* --- Feedback Screen --- */
        #feedback-screen .feedback-message {
            font-size: 2em;
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .feedback-correct {
            color: var(--color-secondary);
        }
        .feedback-wrong {
            color: var(--color-wrong);
        }
        
        .main-question-area {
            margin-bottom: 15px;
        }
        .main-question-area img {
            max-width: 100%;
            max-height: 150px;
            margin: 10px 0;
            border: 3px solid var(--color-secondary);
            border-radius: 5px;
        }
        .main-question-area .term {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .distractor-area-wrapper {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        
        .distractor-details {
            display: flex;
            justify-content: space-around;
            flex-grow: 1;
            gap: 10px;
        }

        .distractor-item {
            flex: 1;
            padding: 5px;
            border: 1px dashed var(--color-gray);
            border-radius: 5px;
        }
        .distractor-item img {
            max-width: 100%;
            max-height: 80px;
            width: auto;
            height: auto;
            display: block;
            margin: 5px auto;
        }
        
        /* New Continue Button (Right Arrow) Style */
        .continue-button-container {
            flex-shrink: 0;
            align-self: flex-end; /* Align to the bottom of its container */
        }
        .next-button {
            padding: 15px 25px;
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            font-size: 1.5em; /* Larger arrow */
            cursor: pointer;
            margin-left: 15px;
        }
        
        .study-again-button {
            padding: 8px 15px;
            background-color: var(--color-wrong);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* --- Loading Screen --- */
        #loading-screen {
            font-size: 1.5em;
            color: var(--color-primary);
        }
        
    </style>
</head>
<body>

    <div id="app">
        
        <div id="loading-screen" class="screen active">
            Loading data... Please wait.
        </div>

        <div id="login-screen" class="screen">
            <h2>What is your name?</h2>
            <input type="text" id="username-input">
            <button onclick="attemptLogin()">Start Game</button>
            <p id="login-message" style="color: var(--color-wrong);"></p>
        </div>

        <div id="home-screen" class="screen">
            <h1 class="home-title">Let's study!</h1>
            <div id="theme-buttons-container" style="width: 100%;">
                <hr style="margin: 20px 0;">
                </div>
            <button id="logout-button" class="study-again-button" style="background-color: var(--color-gray); margin-top: 20px;" onclick="logout()">Log Out</button>
        </div>

        <div id="question-screen" class="screen">
            <button class="exit-button" onclick="goToHome()">‚ùå</button>
            <h2 id="quiz-title">What is this?</h2>
            <div class="timer-container" id="timer-container" style="display:none;">
                <div id="timer-bar"></div>
            </div>
            <img id="question-image" src="" alt="Quiz Image">

            <div id="answer-slots-container" class="answer-slots"></div>
            <div id="letter-choices-container" class="letter-choices"></div>
            <div id="choices-container" style="width: 100%;">
                </div>
        </div>

        <div id="feedback-screen" class="screen">
            <button class="exit-button" onclick="goToHome()">‚ùå</button>
            <h2 class="feedback-message" id="feedback-message"></h2>
            
            <div class="main-question-area">
                <img id="question-feedback-image" src="" alt="Original Question Image">
                <div class="term" id="question-feedback-term"></div>
                <button class="study-again-button" id="demote-button" onclick="demoteTerm()">Study this again</button>
            </div>

            <div class="distractor-area-wrapper">
                <div class="distractor-details">
                    <div class="distractor-item">
                        <img id="distractor1-image" src="" alt="Distractor 1 Image">
                        <div id="distractor1-term"></div>
                    </div>
                    <div class="distractor-item">
                        <img id="distractor2-image" src="" alt="Distractor 2 Image">
                        <div id="distractor2-term"></div>
                    </div>
                </div>
                <div class="continue-button-container">
                    <button class="next-button" onclick="loadQuestion()">‚ñ∂Ô∏è</button>
                </div>
            </div>

            <button id="hidden-home-button" style="display:none;" onclick="goToHome()"></button>
        </div>

    </div>

    <script>
        /* --- JAVASCRIPT LOGIC --- */

        // --- CONFIGURATION ---
        const VALID_IDS = ["Mikael", "Regine"]; // Updated: Now allows "Mikael" or "Regine"
        let CURRENT_USER_ID = null; // Will store the currently logged-in user ID
        const STORAGE_PREFIX = `MasteryQuiz_State_`; // Prefix state key with user ID for segregation
        const LIST_URL = "https://regine-lambrecht.github.io/ingles_Mikael/image_list.txt";
        const BASE_IMAGE_URL = "https://regine-lambrecht.github.io/ingles_Mikael/images/";
        const MEDIUM_TIMER_SECONDS = 5;

        // --- ADVANCED LEVEL STATE ---
        let currentAnswer = []; // Stores letters clicked by user
        let correctTermLetters = []; // Stores the correct term letters for comparison


        // --- STATE VARIABLES ---
        let gameData = []; // Main array of all terms
        let quizPool = []; // Terms for the current quiz session
        let currentQuizIndex = 0;
        let currentQuestion = null;
        let timer = null;
        let totalTerms = 0;
        let currentQuizLevel = null;
        let currentQuizTheme = null;
        let uniqueThemes = new Set();


        // --- UTILITY FUNCTIONS ---

        /**
         * Switches the active screen.
         * @param {string} screenId - The ID of the screen to activate.
         */
        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        /**
         * Loads the game state from localStorage.
         */
        function loadState() {
            if (!CURRENT_USER_ID) return;
            const STORAGE_KEY = STORAGE_PREFIX + CURRENT_USER_ID;
            try {
                const storedState = localStorage.getItem(STORAGE_KEY);
                if (storedState) {
                    const savedData = JSON.parse(storedState);
                    // Merge saved state into current data structure
                    gameData = gameData.map(item => {
                        const savedItem = savedData.find(s => s.term === item.term);
                        if (savedItem) {
                            // Ensure 'Advanced' level is supported when loading old states
                            let savedLevel = savedItem.level || 'New';
                            if (savedLevel === 'Expert' && !gameData.some(d => d.term === item.term && d.level === 'Advanced')) {
                                // If loading an old Expert item, keep it Expert
                            } else if (savedLevel === 'Expert') {
                                // Transition old Expert to Advanced if necessary (optional, but ensures migration)
                                // We keep it Expert for now, promotion rules will handle the rest.
                            }
                            
                            return { ...item, level: savedLevel, correctCount: savedItem.correctCount || 0 };
                        }
                        return item;
                    });
                }
            } catch (e) {
                console.error("Could not load state:", e);
                // Reset state to initial if loading fails
                gameData.forEach(item => { item.level = 'New'; item.correctCount = 0; });
            }
        }

        /**
         * Saves the game state to localStorage.
         */
        function saveState() {
            if (!CURRENT_USER_ID) return;
            const STORAGE_KEY = STORAGE_PREFIX + CURRENT_USER_ID;
            try {
                const stateToSave = gameData.map(item => ({
                    term: item.term,
                    level: item.level,
                    correctCount: item.correctCount
                }));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
                console.log("State saved successfully for " + CURRENT_USER_ID);
            } catch (e) {
                console.error("Could not save state:", e);
            }
        }

        /**
         * Helper function to shuffle an array (used for anagrams/letters)
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Helper function to shuffle a string (used for anagrams)
         */
        function shuffleString(str) {
            return shuffleArray(str.split('')).join('');
        }

        /**
         * Initializes the game data by fetching the list.
         */
        async function initializeData() {
            try {
                const response = await fetch(LIST_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const filenames = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

                gameData = filenames.map(filename => {
                    const cleanName = filename.substring(0, filename.lastIndexOf('.')).replace(/\.(?=[^.]*$)/, ''); // Remove extension
                    const firstUnderscoreIndex = cleanName.indexOf('_');
                    
                    let theme = 'Others'; // Default theme if no underscore is found
                    let term = cleanName;

                    if (firstUnderscoreIndex !== -1) {
                        theme = cleanName.substring(0, firstUnderscoreIndex).trim().replace(/_/g, ' ');
                        term = cleanName.substring(firstUnderscoreIndex + 1).trim().replace(/_/g, ' ');
                    } else {
                          console.warn(`Filename ${filename} does not contain an underscore. Assigned to 'Others'.`);
                    }
                    
                    if (!theme || theme.length === 0) {
                        // Fallback in case theme parsing results in empty string
                        theme = 'Others';
                    }

                    const url = BASE_IMAGE_URL + filename;
                    uniqueThemes.add(theme); // Collect all unique themes

                    return {
                        filename,
                        url,
                        theme,
                        term,
                        level: 'New', // Default
                        correctCount: 0 // Default
                    };
                });
                
                totalTerms = gameData.length;
                switchScreen('login-screen');
            } catch (error) {
                console.error("Error loading or parsing image list:", error);
                document.getElementById('loading-screen').innerHTML = `Error loading data: ${error.message}. Check the console for details.`;
            }
        }
        
        // --- LOGIN / SESSION MANAGEMENT ---

        function attemptLogin() {
            const input = document.getElementById('username-input').value.trim();
            const message = document.getElementById('login-message');

            if (VALID_IDS.includes(input)) {
                CURRENT_USER_ID = input;
                loadState(); // Load state after successful login
                goToHome();
                message.textContent = "";
            } else {
                message.textContent = `Access denied. Valid IDs are: ${VALID_IDS.join(', ')}`;
            }
        }

        function logout() {
            saveState(); // Ensure last state is saved
            CURRENT_USER_ID = null;
            switchScreen('login-screen');
            document.getElementById('username-input').value = '';
            document.getElementById('login-message').textContent = 'Progress saved.';
        }

        // --- GAME FLOW / NAVIGATION ---

        function goToHome() {
            updateHomeCounters();
            clearInterval(timer); // Stop any running timer
            switchScreen('home-screen');
        }

        // --- HOME SCREEN LOGIC ---

        function updateHomeCounters() {
            const container = document.getElementById('theme-buttons-container');
            container.innerHTML = '';

            const themeCounts = {};
            let mediumCount = 0;
            let advancedCount = 0;
            let expertCount = 0;

            // 1. Initialize counts for all known themes to 0
            uniqueThemes.forEach(theme => {
                themeCounts[theme] = 0;
            });

            // 2. Count terms by level and theme
            gameData.forEach(item => {
                if (item.level === 'New' && item.theme && item.theme.length > 0) {
                    themeCounts[item.theme] = (themeCounts[item.theme] || 0) + 1;
                } else if (item.level === 'Medium') {
                    mediumCount++;
                } else if (item.level === 'Advanced') {
                    advancedCount++;
                } else if (item.level === 'Expert') {
                    expertCount++;
                }
            });

            // 3. Inject Theme Buttons (New Level)
            Object.entries(themeCounts)
                .sort(([themeA], [themeB]) => themeA.localeCompare(themeB))
                .forEach(([theme, count]) => {
                    const button = document.createElement('button');
                    button.className = 'theme-button';
                    button.textContent = `${theme} (${count})`;
                    button.onclick = () => startQuiz('New', theme);
                    button.disabled = count === 0; // Disabled if count is 0
                    container.appendChild(button);
                });

            // 4. Add Separator and Level Buttons
            const separator = document.createElement('hr');
            separator.style.margin = '20px 0';
            container.appendChild(separator);

            // Medium Button
            const mediumButton = document.createElement('button');
            mediumButton.id = 'medium-button';
            mediumButton.className = 'theme-button medium-button';
            mediumButton.textContent = `Medium (${mediumCount})`;
            mediumButton.onclick = () => startQuiz('Medium');
            mediumButton.disabled = mediumCount === 0;
            container.appendChild(mediumButton);
            
            // Advanced Button
            const advancedButton = document.createElement('button');
            advancedButton.id = 'advanced-button';
            advancedButton.className = 'theme-button advanced-button';
            advancedButton.textContent = `Advanced (${advancedCount})`;
            advancedButton.onclick = () => startQuiz('Advanced');
            advancedButton.disabled = advancedCount === 0;
            container.appendChild(advancedButton);


            // Expert Button
            const expertButton = document.createElement('button');
            expertButton.id = 'expert-button';
            expertButton.className = 'theme-button expert-button';
            expertButton.textContent = `Expert (${expertCount}/${totalTerms})`;
            expertButton.onclick = () => startQuiz('Expert');
            expertButton.disabled = expertCount === 0;
            container.appendChild(expertButton);
        }

        // --- QUIZ SETUP AND START ---

        function startQuiz(level, theme = null) {
            currentQuizLevel = level;
            currentQuizTheme = theme;

            // Rebuild the quiz pool based on the CURRENT state of gameData
            quizPool = gameData.filter(item => {
                if (level === 'New') {
                    return item.level === 'New' && item.theme === theme;
                }
                return item.level === level;
            });

            if (quizPool.length === 0) {
                goToHome();
                return;
            }

            // Shuffle the pool to randomize question order
            quizPool.sort(() => Math.random() - 0.5);
            currentQuizIndex = 0; // Start at the beginning of the shuffled pool
            
            // Set up timer visibility
            const timerContainer = document.getElementById('timer-container');
            const timerShouldBeActive = (level === 'Medium' || level === 'Advanced');

            if (timerShouldBeActive) {
                timerContainer.style.display = 'block';
            } else {
                clearInterval(timer); // Ensure timer is stopped if switching to non-timed quiz
                timerContainer.style.display = 'none';
            }

            switchScreen('question-screen');
            loadQuestion();
        }

        // --- QUESTION HANDLING ---

        function loadQuestion() {
            // 1. Filter the quiz pool to remove promoted/demoted items
            quizPool = quizPool.filter(item => {
                   const currentState = gameData.find(d => d.term === item.term);
                   let isValid = false;
                   if (currentQuizLevel === 'New' && currentState.level === 'New' && currentState.theme === currentQuizTheme) {
                       isValid = true;
                   } else if (currentQuizLevel === 'Medium' && currentState.level === 'Medium') {
                       isValid = true;
                   } else if (currentQuizLevel === 'Advanced' && currentState.level === 'Advanced') {
                       isValid = true;
                   } else if (currentQuizLevel === 'Expert' && currentState.level === 'Expert') {
                       isValid = true;
                   }
                   return isValid;
            });

            if (quizPool.length === 0) {
                goToHome();
                return;
            }

            // Select the next question
            let itemIndex = currentQuizIndex % quizPool.length;
            currentQuestion = gameData.find(item => item.term === quizPool[itemIndex].term);

            const level = currentQuestion.level;
            const questionImage = document.getElementById('question-image');
            const choicesContainer = document.getElementById('choices-container');
            const slotsContainer = document.getElementById('answer-slots-container');
            const letterContainer = document.getElementById('letter-choices-container');

            // Reset UI for the new question
            slotsContainer.innerHTML = '';
            letterContainer.innerHTML = '';
            choicesContainer.innerHTML = '';
            currentAnswer = [];


            // 2. Expert level is just review
            if (level === 'Expert') {
                showExpertReview();
                currentQuizIndex++; 
                return;
            }

            // Show/Hide elements based on level
            if (level === 'Advanced') {
                questionImage.style.display = 'block';
                questionImage.src = currentQuestion.url;
                choicesContainer.style.display = 'none';
                document.getElementById('quiz-title').textContent = "Spell the word:";

                // Start the Interactive Spelling Game
                renderSpellingGame(currentQuestion);

            } else {
                // New / Medium Level (Standard Multiple Choice)
                questionImage.style.display = 'block';
                questionImage.src = currentQuestion.url;
                choicesContainer.style.display = 'block';
                document.getElementById('quiz-title').textContent = "What is this?";

                // 3. Get Distractors (only needed for New/Medium)
                const distractors = getDistractors(level, currentQuestion);

                // 4. Render standard multiple choice
                renderQuizChoices(currentQuestion, distractors);
            }


            // 5. Start Timer
            if (level === 'Medium' || level === 'Advanced') {
                startTimer();
            } else {
                clearInterval(timer);
            }
            
            // 6. Advance the index
            currentQuizIndex++; 
            if (currentQuizIndex >= quizPool.length && quizPool.length > 0) {
                // Re-shuffle and reset index if we've cycled through all available questions
                quizPool.sort(() => Math.random() - 0.5);
                currentQuizIndex = 0;
            }
            
            switchScreen('question-screen');
        }

        /**
         * Logic to find distractors for New/Medium levels.
         */
        function getDistractors(level, question) {
            const distractors = [];
            let availableTerms = [];
            
            if (level === 'New') {
                // For 'New', prioritize other 'New' terms within the SAME theme
                availableTerms = gameData.filter(item => 
                    item.level === 'New' && item.theme === question.theme && item.term !== question.term
                );
            } 
            
            // SECONDARY POOL: All 'New' terms globally.
            if (level === 'Medium' || availableTerms.length < 2) {
                const globalPool = gameData.filter(item => 
                    item.term !== question.term && item.level === 'New'
                );
                
                availableTerms = globalPool.slice(); 
            }
            
            // Draw initial distractors from the available pool
            availableTerms.sort(() => Math.random() - 0.5); 
            
            while (distractors.length < 2 && availableTerms.length > 0) {
                distractors.push(availableTerms.pop());
            }

            // TERTIARY POOL: Fallback to ANY other term if still missing distractors
            if (distractors.length < 2) {
                const allOtherTerms = gameData.filter(item => item.term !== question.term && 
                                                              !distractors.some(d => d.term === item.term));
                allOtherTerms.sort(() => Math.random() - 0.5);
                while (distractors.length < 2 && allOtherTerms.length > 0) {
                    distractors.push(allOtherTerms.pop());
                }
            }
            return distractors;
        }
        
        /**
         * Renders standard multiple choice buttons (New and Medium levels).
         */
        function renderQuizChoices(question, distractors) {
            const choicesContainer = document.getElementById('choices-container');
            
            const choices = [question, ...distractors];
            choices.sort(() => Math.random() - 0.5); // Randomize button order

            choices.forEach(item => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = item.term;
                // Note: Distractors array is passed empty for advanced, but here it's real
                button.onclick = () => submitAnswer(item, distractors); 
                choicesContainer.appendChild(button);
            });
        }

        /**
         * Renders the interactive spelling game (Advanced level).
         */
        function renderSpellingGame(question) {
            const slotsContainer = document.getElementById('answer-slots-container');
            const letterContainer = document.getElementById('letter-choices-container');
            
            // 1. Prepare correct term (Remove spaces and capitalize for consistency)
            const cleanTerm = question.term.replace(/\s/g, '').toUpperCase(); 
            correctTermLetters = cleanTerm.split('');

            // 2. Create answer slots
            correctTermLetters.forEach((letter, index) => {
                const slot = document.createElement('div');
                slot.className = 'letter-slot';
                slot.id = `slot-${index}`;
                slotsContainer.appendChild(slot);
            });

            // 3. Create shuffled letter buttons
            const shuffledLetters = shuffleArray(correctTermLetters.slice()); // Clone and shuffle
            
            shuffledLetters.forEach((letter, index) => {
                const button = document.createElement('button');
                button.className = 'letter-button';
                button.textContent = letter;
                button.dataset.letter = letter;
                button.dataset.index = index; // Use unique index for tracking
                button.onclick = () => clickLetter(button);
                letterContainer.appendChild(button);
            });
        }

        /**
         * Handles the user clicking a letter button.
         */
        function clickLetter(button) {
            const slots = document.getElementById('answer-slots-container').children;
            const currentIndex = currentAnswer.length;

            if (currentIndex < correctTermLetters.length) {
                const letter = button.dataset.letter;
                
                // 1. Fill the current open slot
                slots[currentIndex].textContent = letter;
                currentAnswer.push(letter);
                
                // 2. Disable the clicked button
                button.disabled = true;

                // 3. Check if the word is complete
                if (currentAnswer.length === correctTermLetters.length) {
                    clearInterval(timer);
                    checkAnswer();
                }
            }
        }

        /**
         * Compares the user's input with the correct answer.
         */
        function checkAnswer() {
            const userAnswer = currentAnswer.join('');
            const correctAnswer = correctTermLetters.join('');
            const isCorrect = userAnswer === correctAnswer;

            // Submit with an empty distractor array, as they are not relevant to feedback here
            submitAnswer(isCorrect ? currentQuestion : null, []); 
        }

        function showExpertReview() {
            clearInterval(timer);
            
            document.getElementById('feedback-message').textContent = "Review: Expert";
            document.getElementById('feedback-message').className = 'feedback-message';

            // Display question details
            document.getElementById('question-feedback-image').src = currentQuestion.url;
            document.getElementById('question-feedback-image').style.display = 'block';
            document.getElementById('question-feedback-term').textContent = currentQuestion.term;
            
            // Hide distractor details as there was no quiz
            document.querySelector('.distractor-details').style.display = 'none';
            document.querySelector('.continue-button-container').style.display = 'block';


            // Show demote button (allows demotion from Expert for revision)
            const demoteBtn = document.getElementById('demote-button');
            demoteBtn.style.display = 'block';
            demoteBtn.textContent = "Demote to Advanced"; 

            switchScreen('feedback-screen');
        }

        function startTimer() {
            clearInterval(timer);
            const totalTime = MEDIUM_TIMER_SECONDS * 1000;
            let timeRemaining = totalTime;
            const bar = document.getElementById('timer-bar');

            bar.style.width = '100%';

            timer = setInterval(() => {
                timeRemaining -= 100;
                const percentage = (timeRemaining / totalTime) * 100;
                bar.style.width = percentage + '%';

                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    // Disable letters/choices on timeout
                    document.querySelectorAll('.letter-button, .choice-button').forEach(btn => btn.disabled = true);
                    
                    // If Advanced level, submit wrong answer
                    if (currentQuizLevel === 'Advanced') {
                        submitAnswer(null, []);
                    } else {
                        // For New/Medium, submit wrong answer (null chosen item)
                        submitAnswer(null, getDistractors(currentQuizLevel, currentQuestion));
                    }
                }
            }, 100);
        }

        function submitAnswer(chosenItem, distractors) {
            clearInterval(timer);
            // Disable all buttons immediately after submission or timeout
            document.querySelectorAll('.letter-button, .choice-button').forEach(btn => btn.disabled = true);

            // Determine if the answer was correct (handles both standard quiz and spelling)
            const isCorrect = chosenItem && chosenItem.term === currentQuestion.term;
            
            processProgress(isCorrect);
            showFeedback(isCorrect, currentQuestion, distractors, chosenItem);

            saveState(); // Save progress after every question
        }

        // --- PROGRESS MANAGEMENT ---

        function processProgress(isCorrect) {
            const item = currentQuestion;
            const currentLevel = item.level;

            if (isCorrect) {
                item.correctCount++;
                if (currentLevel === 'New' && item.correctCount >= 3) {
                    item.level = 'Medium';
                    item.correctCount = 0;
                } else if (currentLevel === 'Medium' && item.correctCount >= 3) {
                    item.level = 'Advanced';
                    item.correctCount = 0;
                } else if (currentLevel === 'Advanced' && item.correctCount >= 3) {
                    item.level = 'Expert'; // Promote Advanced to Expert
                    item.correctCount = 0;
                }
            } else {
                // Wrong answer / Time's up
                item.correctCount++; // Increment count of fails
                
                // Demotion Rule: If Advanced and failed 3 times
                if (currentLevel === 'Advanced' && item.correctCount >= 3) {
                    item.level = 'Medium'; // Demote Advanced to Medium
                    item.correctCount = 0;
                } else {
                    item.correctCount = 0; // Reset consecutive correct count for other levels
                }
            }
            // Update the main gameData array
            const index = gameData.findIndex(d => d.term === item.term);
            if (index !== -1) {
                gameData[index].level = item.level;
                gameData[index].correctCount = item.correctCount;
            }
        }
        
        function demoteTerm() {
            const item = currentQuestion;
            
            if (item.level === 'Expert') {
                item.level = 'Advanced'; // Demote from Expert to Advanced
                item.correctCount = 0;
            } else if (item.level === 'Advanced') {
                item.level = 'Medium'; // Demote from Advanced to Medium
                item.correctCount = 0;
            } else if (item.level === 'Medium') {
                item.level = 'New'; 
                item.correctCount = 0;
            }
            
            // Update the main gameData array
            const index = gameData.findIndex(d => d.term === item.term);
            if (index !== -1) {
                gameData[index].level = item.level;
                gameData[index].correctCount = 0;
            }

            saveState();
            goToHome(); // Go to home after demoting
        }

        // --- FEEDBACK SCREEN ---

        function showFeedback(isCorrect, question, distractors, chosenItem) {
            
            // 1. Message
            const messageElement = document.getElementById('feedback-message');
            messageElement.textContent = isCorrect ? "You are right! üéâ" : "You are wrong! üòû";
            messageElement.className = `feedback-message ${isCorrect ? 'feedback-correct' : 'feedback-wrong'}`;

            // Handle Time's up message (Simplified)
            if (!isCorrect && !chosenItem) {
                 messageElement.textContent = "Time's up! üòû";
            }

            // 2. Question Detail (Always Shown)
            document.getElementById('question-feedback-image').src = question.url;
            document.getElementById('question-feedback-term').textContent = question.term;
            
            // Show image if it was hidden for Advanced level
            document.getElementById('question-feedback-image').style.display = 'block';

            // 3. Demote Button
            const demoteBtn = document.getElementById('demote-button');
            const currentLevel = question.level;
            
            // NOTE: The game logic updates the level *before* showing feedback if a promotion/demotion happened.
            
            // If the user was on Advanced and failed (correctCount >= 3), they are already demoted to Medium. 
            // In that specific case, we hide the demote button on the feedback screen because the failure already resulted in demotion.

            if (currentLevel === 'Expert') {
                 demoteBtn.style.display = 'block';
                 demoteBtn.textContent = "Demote to Advanced";
            } else if (currentLevel === 'Advanced' && !isCorrect) {
                 demoteBtn.style.display = 'block';
                 demoteBtn.textContent = "Study this again (Demote to Medium)";
            } else if (currentLevel === 'Medium' && !isCorrect) {
                 demoteBtn.style.display = 'block';
                 demoteBtn.textContent = "Study this again (Demote to New)";
            } else {
                 demoteBtn.style.display = 'none'; // Hide if correct or New level
            }
            
            // 4. Distractor Details 
            const distractorDetailsContainer = document.querySelector('.distractor-details');
            document.querySelector('.continue-button-container').style.display = 'block';

            // Distractor details are only relevant for New/Medium quizzes
            if (currentLevel === 'New' || currentLevel === 'Medium') {
                distractorDetailsContainer.style.display = 'flex';
                
                // Note: We cannot rely on the 'distractors' parameter passed to this function 
                // in the event of a timeout on the New/Medium level. Re-fetching is safer.
                const relevantDistractors = getDistractors(currentLevel, question);

                // Set Distractor 1
                if (relevantDistractors[0]) {
                    document.getElementById('distractor1-image').src = relevantDistractors[0].url;
                    document.getElementById('distractor1-term').textContent = relevantDistractors[0].term;
                    document.querySelector('.distractor-item:nth-child(1)').style.display = 'block';
                } else {
                    document.querySelector('.distractor-item:nth-child(1)').style.display = 'none';
                }
                
                // Set Distractor 2
                if (relevantDistractors[1]) {
                    document.getElementById('distractor2-image').src = relevantDistractors[1].url;
                    document.getElementById('distractor2-term').textContent = relevantDistractors[1].term;
                    document.querySelector('.distractor-item:nth-child(2)').style.display = 'block';
                } else {
                    document.querySelector('.distractor-item:nth-child(2)').style.display = 'none';
                }

            } else {
                 // Hide distractors for Advanced and Expert
                 distractorDetailsContainer.style.display = 'none';
            }
            
            switchScreen('feedback-screen');
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeData();
        });
    </script>
</body>
</html>
