<!DOCTYPE TML>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Mastery Quiz</title>
Â  Â  <style>
Â  Â  Â  Â  /* --- CSS STYLES (Mobile-First Responsive Design) --- */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --color-primary: #3498db;
Â  Â  Â  Â  Â  Â  --color-secondary: #2ecc71;
Â  Â  Â  Â  Â  Â  --color-wrong: #e74c3c;
Â  Â  Â  Â  Â  Â  --color-bg: #ecf0f1;
Â  Â  Â  Â  Â  Â  --color-text: #2c3e50;
Â  Â  Â  Â  Â  Â  --color-light-text: #fefefe;
Â  Â  Â  Â  Â  Â  --color-gray: #bdc3c7;
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: sans-serif;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  background-color: var(--color-bg);
Â  Â  Â  Â  Â  Â  color: var(--color-text);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  }

Â  Â  Â  Â  #app {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  Â  Â  position: relative; /* Needed for absolute positioning of exit button */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Screens --- */
Â  Â  Â  Â  .screen {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .screen.active {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Login Screen --- */
Â  Â  Â  Â  #login-screen input[type="text"],
Â  Â  Â  Â  #login-screen button {
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  margin: 10px 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 300px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #login-screen input[type="text"] {
Â  Â  Â  Â  Â  Â  border: 1px solid var(--color-gray);
Â  Â  Â  Â  }
Â  Â  Â  Â  #login-screen button {
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);
Â  Â  Â  Â  Â  Â  color: var(--color-light-text);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Home Screen --- */
Â  Â  Â  Â  .home-title {
Â  Â  Â  Â  Â  Â  color: var(--color-primary);
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  font-size: 1.8em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .theme-button {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  margin: 8px 0;
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);
Â  Â  Â  Â  Â  Â  color: var(--color-light-text);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .theme-button:hover:not(:disabled) {
Â  Â  Â  Â  Â  Â  background-color: #2980b9;
Â  Â  Â  Â  }
Â  Â  Â  Â  .theme-button:disabled {
Â  Â  Â  Â  Â  Â  background-color: var(--color-gray);
Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  }
Â  Â  Â  Â  .medium-button, .expert-button {
Â  Â  Â  Â  Â  Â  background-color: var(--color-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .medium-button:hover:not(:disabled), .expert-button:hover:not(:disabled) {
Â  Â  Â  Â  Â  Â  background-color: #27ae60;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Quiz Screen / Feedback Screen Common --- */
Â  Â  Â  Â  .exit-button {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 20px;
Â  Â  Â  Â  Â  Â  left: 20px;
Â  Â  Â  Â  Â  Â  background: none;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  font-size: 1.5em;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  color: var(--color-wrong);
Â  Â  Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  }
Â  Â  Â  Â  #question-screen h3 {
Â  Â  Â  Â  Â  Â  margin-bottom: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  #question-image {
Â  Â  Â  Â  Â  Â  max-width: 90%;
Â  Â  Â  Â  Â  Â  max-height: 200px;
Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  Â  Â  margin: 20px 0;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--color-gray);
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  .choice-button {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  Â  Â  margin: 5px 0;
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);
Â  Â  Â  Â  Â  Â  color: var(--color-light-text);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .choice-button:hover {
Â  Â  Â  Â  Â  Â  background-color: #2980b9;
Â  Â  Â  Â  }
Â  Â  Â  Â  #timer-bar {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 10px;
Â  Â  Â  Â  Â  Â  background-color: var(--color-wrong);
Â  Â  Â  Â  Â  Â  transition: width 0.1s linear;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .timer-container {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  background-color: var(--color-gray);
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Feedback Screen --- */
Â  Â  Â  Â  #feedback-screen .feedback-message {
Â  Â  Â  Â  Â  Â  font-size: 2em;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .feedback-correct {
Â  Â  Â  Â  Â  Â  color: var(--color-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .feedback-wrong {
Â  Â  Â  Â  Â  Â  color: var(--color-wrong);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .main-question-area {
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .main-question-area img {
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  Â  Â  max-height: 150px;
Â  Â  Â  Â  Â  Â  margin: 10px 0;
Â  Â  Â  Â  Â  Â  border: 3px solid var(--color-secondary);
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .main-question-area .term {
Â  Â  Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .distractor-area-wrapper {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .distractor-details {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-around;
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .distractor-item {
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  Â  border: 1px dashed var(--color-gray);
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .distractor-item img {
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  Â  Â  max-height: 80px;
Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin: 5px auto;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* New Continue Button (Right Arrow) Style */
Â  Â  Â  Â  .continue-button-container {
Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  Â  Â  align-self: flex-end; /* Align to the bottom of its container */
Â  Â  Â  Â  }
Â  Â  Â  Â  .next-button {
Â  Â  Â  Â  Â  Â  padding: 15px 25px;
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);
Â  Â  Â  Â  Â  Â  color: var(--color-light-text);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  font-size: 1.5em; /* Larger arrow */
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  margin-left: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .study-again-button {
Â  Â  Â  Â  Â  Â  padding: 8px 15px;
Â  Â  Â  Â  Â  Â  background-color: var(--color-wrong);
Â  Â  Â  Â  Â  Â  color: var(--color-light-text);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Loading Screen --- */
Â  Â  Â  Â  #loading-screen {
Â  Â  Â  Â  Â  Â  font-size: 1.5em;
Â  Â  Â  Â  Â  Â  color: var(--color-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  </style>
</head>
<body>

Â  Â  <div id="app">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="loading-screen" class="screen active">
Â  Â  Â  Â  Â  Â  Loading data... Please wait.
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="login-screen" class="screen">
Â  Â  Â  Â  Â  Â  <h2>Enter Your ID</h2>
Â  Â  Â  Â  Â  Â  <input type="text" id="username-input" placeholder="Enter your ID">
Â  Â  Â  Â  Â  Â  <button onclick="attemptLogin()">Start Game</button>
Â  Â  Â  Â  Â  Â  <p id="login-message" style="color: var(--color-wrong);"></p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="home-screen" class="screen">
Â  Â  Â  Â  Â  Â  <h1 class="home-title">Let's study!</h1>
Â  Â  Â  Â  Â  Â  <div id="theme-buttons-container" style="width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  <hr style="margin: 20px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="medium-button" class="theme-button medium-button" onclick="startQuiz('Medium')">Medium (<span id="medium-counter">0</span>)</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="expert-button" class="theme-button expert-button" onclick="startQuiz('Expert')">Expert (<span id="expert-counter">0/0</span>)</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="logout-button" class="study-again-button" style="background-color: var(--color-gray); margin-top: 20px;" onclick="logout()">Log Out</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="question-screen" class="screen">
Â  Â  Â  Â  Â  Â  <button class="exit-button" onclick="goToHome()">âŒ</button>
Â  Â  Â  Â  Â  Â  <h2 id="quiz-title">What is this?</h2>
Â  Â  Â  Â  Â  Â  <div class="timer-container" id="timer-container" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="timer-bar"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <img id="question-image" src="" alt="Quiz Image">
Â  Â  Â  Â  Â  Â  <div id="choices-container" style="width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="feedback-screen" class="screen">
Â  Â  Â  Â  Â  Â  <button class="exit-button" onclick="goToHome()">âŒ</button>
Â  Â  Â  Â  Â  Â  <h2 class="feedback-message" id="feedback-message"></h2>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="main-question-area">
Â  Â  Â  Â  Â  Â  Â  Â  <img id="question-feedback-image" src="" alt="Original Question Image">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="term" id="question-feedback-term"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="study-again-button" id="demote-button" onclick="demoteTerm()">Study this again</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="distractor-area-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="distractor-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="distractor-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="distractor1-image" src="" alt="Distractor 1 Image">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="distractor1-term"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="distractor-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="distractor2-image" src="" alt="Distractor 2 Image">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="distractor2-term"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="continue-button-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="next-button" onclick="loadQuestion()">â–¶ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <button id="hidden-home-button" style="display:none;" onclick="goToHome()"></button>
Â  Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  /* --- JAVASCRIPT LOGIC --- */

Â  Â  Â  Â  // --- CONFIGURATION ---
Â  Â  Â  Â  const VALID_IDS = ["Mikael", "Regine"]; // Updated: Now allows "Mikael" or "Regine"
Â  Â  Â  Â  let CURRENT_USER_ID = null; // Will store the currently logged-in user ID
Â  Â  Â  Â  const STORAGE_PREFIX = `MasteryQuiz_State_`; // Prefix state key with user ID for segregation
Â  Â  Â  Â  const LIST_URL = "https://regine-lambrecht.github.io/ingles_Mikael/image_list.txt";
Â  Â  Â  Â  const BASE_IMAGE_URL = "https://regine-lambrecht.github.io/ingles_Mikael/images/";
Â  Â  Â  Â  const MEDIUM_TIMER_SECONDS = 5;

Â  Â  Â  Â  // --- STATE VARIABLES ---
Â  Â  Â  Â  let gameData = []; // Main array of all terms
Â  Â  Â  Â  let quizPool = []; // Terms for the current quiz session
Â  Â  Â  Â  let currentQuizIndex = 0;
Â  Â  Â  Â  let currentQuestion = null;
Â  Â  Â  Â  let timer = null;
Â  Â  Â  Â  let totalTerms = 0;
Â  Â  Â  Â  let currentQuizLevel = null;
Â  Â  Â  Â  let currentQuizTheme = null;
Â  Â  Â  Â  let uniqueThemes = new Set();


Â  Â  Â  Â  // --- UTILITY FUNCTIONS ---

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Switches the active screen.
Â  Â  Â  Â  Â * @param {string} screenId - The ID of the screen to activate.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function switchScreen(screenId) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.screen').forEach(screen => {
Â  Â  Â  Â  Â  Â  Â  Â  screen.classList.remove('active');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById(screenId).classList.add('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Loads the game state from localStorage.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function loadState() {
Â  Â  Â  Â  Â  Â  if (!CURRENT_USER_ID) return;
Â  Â  Â  Â  Â  Â  const STORAGE_KEY = STORAGE_PREFIX + CURRENT_USER_ID;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const storedState = localStorage.getItem(STORAGE_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  if (storedState) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedData = JSON.parse(storedState);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Merge saved state into current data structure
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameData = gameData.map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedItem = savedData.find(s => s.term === item.term);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (savedItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { ...item, level: savedItem.level || 'New', correctCount: savedItem.correctCount || 0 };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return item;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Could not load state:", e);
Â  Â  Â  Â  Â  Â  Â  Â  // Reset state to initial if loading fails
Â  Â  Â  Â  Â  Â  Â  Â  gameData.forEach(item => { item.level = 'New'; item.correctCount = 0; });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Saves the game state to localStorage.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function saveState() {
Â  Â  Â  Â  Â  Â  if (!CURRENT_USER_ID) return;
Â  Â  Â  Â  Â  Â  const STORAGE_KEY = STORAGE_PREFIX + CURRENT_USER_ID;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const stateToSave = gameData.map(item => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  term: item.term,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  level: item.level,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctCount: item.correctCount
Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
Â  Â  Â  Â  Â  Â  Â  Â  console.log("State saved successfully for " + CURRENT_USER_ID);
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Could not save state:", e);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Initializes the game data by fetching the list.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function initializeData() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(LIST_URL);
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  const text = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  const filenames = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

Â  Â  Â  Â  Â  Â  Â  Â  gameData = filenames.map(filename => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cleanName = filename.substring(0, filename.lastIndexOf('.')).replace(/\.(?=[^.]*$)/, ''); // Remove extension
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const firstUnderscoreIndex = cleanName.indexOf('_');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let theme = 'Others'; // Default theme if no underscore is found
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let term = cleanName;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (firstUnderscoreIndex !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  theme = cleanName.substring(0, firstUnderscoreIndex).trim().replace(/_/g, ' ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  term = cleanName.substring(firstUnderscoreIndex + 1).trim().replace(/_/g, ' ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn(`Filename ${filename} does not contain an underscore. Assigned to 'Others'.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!theme || theme.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fallback in case theme parsing results in empty string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  theme = 'Others';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const url = BASE_IMAGE_URL + filename;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uniqueThemes.add(theme); // Collect all unique themes

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  filename,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  url,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  theme,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  level: 'New', // Default
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctCount: 0 // Default
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  totalTerms = gameData.length;
Â  Â  Â  Â  Â  Â  Â  Â  switchScreen('login-screen');
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error loading or parsing image list:", error);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loading-screen').innerHTML = `Error loading data: ${error.message}. Check the console for details.`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- LOGIN / SESSION MANAGEMENT ---

Â  Â  Â  Â  function attemptLogin() {
Â  Â  Â  Â  Â  Â  const input = document.getElementById('username-input').value.trim();
Â  Â  Â  Â  Â  Â  const message = document.getElementById('login-message');

Â  Â  Â  Â  Â  Â  if (VALID_IDS.includes(input)) {
Â  Â  Â  Â  Â  Â  Â  Â  CURRENT_USER_ID = input;
Â  Â  Â  Â  Â  Â  Â  Â  loadState(); // Load state after successful login
Â  Â  Â  Â  Â  Â  Â  Â  goToHome();
Â  Â  Â  Â  Â  Â  Â  Â  message.textContent = "";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  message.textContent = `Access denied. Valid IDs are: ${VALID_IDS.join(', ')}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function logout() {
Â  Â  Â  Â  Â  Â  saveState(); // Ensure last state is saved
Â  Â  Â  Â  Â  Â  CURRENT_USER_ID = null;
Â  Â  Â  Â  Â  Â  switchScreen('login-screen');
Â  Â  Â  Â  Â  Â  document.getElementById('username-input').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('login-message').textContent = 'Progress saved.';
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- GAME FLOW / NAVIGATION ---

Â  Â  Â  Â  function goToHome() {
Â  Â  Â  Â  Â  Â  updateHomeCounters();
Â  Â  Â  Â  Â  Â  clearInterval(timer); // Stop any running timer
Â  Â  Â  Â  Â  Â  switchScreen('home-screen');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- HOME SCREEN LOGIC ---

Â  Â  Â  Â  function updateHomeCounters() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('theme-buttons-container');
Â  Â  Â  Â  Â  Â  container.innerHTML = '';

Â  Â  Â  Â  Â  Â  const themeCounts = {};
Â  Â  Â  Â  Â  Â  let mediumCount = 0;
Â  Â  Â  Â  Â  Â  let expertCount = 0;

Â  Â  Â  Â  Â  Â  // 1. Initialize counts for all known themes to 0
Â  Â  Â  Â  Â  Â  uniqueThemes.forEach(theme => {
Â  Â  Â  Â  Â  Â  Â  Â  themeCounts[theme] = 0;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 2. Count terms by level and theme
Â  Â  Â  Â  Â  Â  gameData.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  if (item.level === 'New' && item.theme && item.theme.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  themeCounts[item.theme] = (themeCounts[item.theme] || 0) + 1;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (item.level === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mediumCount++;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (item.level === 'Expert') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  expertCount++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 3. Inject Theme Buttons (including those with a count of 0)
Â  Â  Â  Â  Â  Â  Object.entries(themeCounts)
Â  Â  Â  Â  Â  Â  Â  Â  .sort(([themeA], [themeB]) => themeA.localeCompare(themeB))
Â  Â  Â  Â  Â  Â  Â  Â  .forEach(([theme, count]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.className = 'theme-button';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.textContent = `${theme} (${count})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.onclick = () => startQuiz('New', theme);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.disabled = count === 0; // Disabled if count is 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(button);
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 4. Add Separator and Level Buttons
Â  Â  Â  Â  Â  Â  const separator = document.createElement('hr');
Â  Â  Â  Â  Â  Â  separator.style.margin = '20px 0';
Â  Â  Â  Â  Â  Â  container.appendChild(separator);

Â  Â  Â  Â  Â  Â  const mediumButton = document.createElement('button');
Â  Â  Â  Â  Â  Â  mediumButton.id = 'medium-button';
Â  Â  Â  Â  Â  Â  mediumButton.className = 'theme-button medium-button';
Â  Â  Â  Â  Â  Â  mediumButton.textContent = `Medium (${mediumCount})`;
Â  Â  Â  Â  Â  Â  mediumButton.onclick = () => startQuiz('Medium');
Â  Â  Â  Â  Â  Â  mediumButton.disabled = mediumCount === 0;
Â  Â  Â  Â  Â  Â  container.appendChild(mediumButton);

Â  Â  Â  Â  Â  Â  const expertButton = document.createElement('button');
Â  Â  Â  Â  Â  Â  expertButton.id = 'expert-button';
Â  Â  Â  Â  Â  Â  expertButton.className = 'theme-button expert-button';
Â  Â  Â  Â  Â  Â  expertButton.textContent = `Expert (${expertCount}/${totalTerms})`;
Â  Â  Â  Â  Â  Â  expertButton.onclick = () => startQuiz('Expert');
Â  Â  Â  Â  Â  Â  expertButton.disabled = expertCount === 0;
Â  Â  Â  Â  Â  Â  container.appendChild(expertButton);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- QUIZ SETUP AND START ---

Â  Â  Â  Â  function startQuiz(level, theme = null) {
Â  Â  Â  Â  Â  Â  currentQuizLevel = level;
Â  Â  Â  Â  Â  Â  currentQuizTheme = theme;

Â  Â  Â  Â  Â  Â  // Rebuild the quiz pool based on the CURRENT state of gameData
Â  Â  Â  Â  Â  Â  quizPool = gameData.filter(item => {
Â  Â  Â  Â  Â  Â  Â  Â  if (level === 'New') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return item.level === 'New' && item.theme === theme;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return item.level === level;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (quizPool.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  goToHome();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Shuffle the pool to randomize question order
Â  Â  Â  Â  Â  Â  quizPool.sort(() => Math.random() - 0.5);
Â  Â  Â  Â  Â  Â  currentQuizIndex = 0; // Start at the beginning of the shuffled pool
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Set up timer visibility
Â  Â  Â  Â  Â  Â  const timerContainer = document.getElementById('timer-container');
Â  Â  Â  Â  Â  Â  if (level === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  timerContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(timer); // Ensure timer is stopped if switching to non-timed quiz
Â  Â  Â  Â  Â  Â  Â  Â  timerContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  switchScreen('question-screen');
Â  Â  Â  Â  Â  Â  loadQuestion();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- QUESTION HANDLING ---

Â  Â  Â  Â  function loadQuestion() {
Â  Â  Â  Â  Â  Â  // 1. Filter the quiz pool to remove promoted/demoted items
Â  Â  Â  Â  Â  Â  quizPool = quizPool.filter(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const currentState = gameData.find(d => d.term === item.term);
Â  Â  Â  Â  Â  Â  Â  Â  Â let isValid = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â if (currentQuizLevel === 'New' && currentState.level === 'New' && currentState.theme === currentQuizTheme) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isValid = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â } else if (currentQuizLevel === 'Medium' && currentState.level === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isValid = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â } else if (currentQuizLevel === 'Expert' && currentState.level === 'Expert') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isValid = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â return isValid;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (quizPool.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  goToHome();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Select the next question
Â  Â  Â  Â  Â  Â  let itemIndex = currentQuizIndex % quizPool.length;
Â  Â  Â  Â  Â  Â  currentQuestion = gameData.find(item => item.term === quizPool[itemIndex].term);


Â  Â  Â  Â  Â  Â  const level = currentQuestion.level;

Â  Â  Â  Â  Â  Â  // 2. Expert level is just review
Â  Â  Â  Â  Â  Â  if (level === 'Expert') {
Â  Â  Â  Â  Â  Â  Â  Â  showExpertReview();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  currentQuizIndex++;Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (currentQuizIndex >= quizPool.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Re-shuffle and reset index if we've cycled through all available questions
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quizPool.sort(() => Math.random() - 0.5);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentQuizIndex = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 3. Get Distractors
Â  Â  Â  Â  Â  Â  let distractorPool;
Â  Â  Â  Â  Â  Â  if (level === 'New') {
Â  Â  Â  Â  Â  Â  Â  Â  // New: Try to get distractors from other 'New' terms within the SAME theme
Â  Â  Â  Â  Â  Â  Â  Â  distractorPool = gameData.filter(item =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.level === 'New' && item.theme === currentQuestion.theme && item.term !== currentQuestion.term
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback: If not enough, use all 'New' terms
Â  Â  Â  Â  Â  Â  Â  Â  if (distractorPool.length < 2) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  distractorPool = gameData.filter(item => item.level === 'New' && item.term !== currentQuestion.term);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (level === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  // Medium: Distractors from all 'New' terms across ALL themes
Â  Â  Â  Â  Â  Â  Â  Â  distractorPool = gameData.filter(item => item.level === 'New' && item.term !== currentQuestion.term);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  distractorPool = [];
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Select 2 unique distractors from the prepared pool
Â  Â  Â  Â  Â  Â  const distractors = [];
Â  Â  Â  Â  Â  Â  let availableTerms = distractorPool.slice(); // Copy the final pool
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  while (distractors.length < 2 && availableTerms.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const randomIndex = Math.floor(Math.random() * availableTerms.length);
Â  Â  Â  Â  Â  Â  Â  Â  const selectedItem = availableTerms[randomIndex];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  distractors.push(selectedItem);
Â  Â  Â  Â  Â  Â  Â  Â  // Remove the term so it's not picked again
Â  Â  Â  Â  Â  Â  Â  Â  availableTerms.splice(randomIndex, 1);
Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  // 4. Prepare Choices
Â  Â  Â  Â  Â  Â  const choices = [currentQuestion, ...distractors];
Â  Â  Â  Â  Â  Â  choices.sort(() => Math.random() - 0.5); // Randomize button order

Â  Â  Â  Â  Â  Â  // 5. Render Quiz
Â  Â  Â  Â  Â  Â  document.getElementById('question-image').src = currentQuestion.url;
Â  Â  Â  Â  Â  Â  const choicesContainer = document.getElementById('choices-container');
Â  Â  Â  Â  Â  Â  choicesContainer.innerHTML = '';

Â  Â  Â  Â  Â  Â  choices.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  button.className = 'choice-button';
Â  Â  Â  Â  Â  Â  Â  Â  button.textContent = item.term;
Â  Â  Â  Â  Â  Â  Â  Â  button.onclick = () => submitAnswer(item, distractors);
Â  Â  Â  Â  Â  Â  Â  Â  choicesContainer.appendChild(button);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 6. Start Timer if Medium
Â  Â  Â  Â  Â  Â  if (level === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  startTimer();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Advance the index for the next question (handles wrapping around the pool)
Â  Â  Â  Â  Â  Â  currentQuizIndex++;Â 
Â  Â  Â  Â  Â  Â  if (currentQuizIndex >= quizPool.length) {
Â  Â  Â  Â  Â  Â  Â  Â  // Re-shuffle and reset index if we've cycled through all available questions
Â  Â  Â  Â  Â  Â  Â  Â  quizPool.sort(() => Math.random() - 0.5);
Â  Â  Â  Â  Â  Â  Â  Â  currentQuizIndex = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Re-activate question screen in case coming from feedback
Â  Â  Â  Â  Â  Â  switchScreen('question-screen');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function showExpertReview() {
Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('feedback-message').textContent = "Review: Expert";
Â  Â  Â  Â  Â  Â  document.getElementById('feedback-message').className = 'feedback-message';

Â  Â  Â  Â  Â  Â  // Display question details
Â  Â  Â  Â  Â  Â  document.getElementById('question-feedback-image').src = currentQuestion.url;
Â  Â  Â  Â  Â  Â  document.getElementById('question-feedback-term').textContent = currentQuestion.term;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Hide distractor details as there was no quiz
Â  Â  Â  Â  Â  Â  document.querySelector('.distractor-details').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.querySelector('.continue-button-container').style.display = 'block';


Â  Â  Â  Â  Â  Â  // HIDE demote button (It's expert review, not a failure)
Â  Â  Â  Â  Â  Â  document.getElementById('demote-button').style.display = 'none';Â 

Â  Â  Â  Â  Â  Â  switchScreen('feedback-screen');
Â  Â  Â  Â  }

Â  Â  Â  Â  function startTimer() {
Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â  const totalTime = MEDIUM_TIMER_SECONDS * 1000;
Â  Â  Â  Â  Â  Â  let timeRemaining = totalTime;
Â  Â  Â  Â  Â  Â  const bar = document.getElementById('timer-bar');

Â  Â  Â  Â  Â  Â  bar.style.width = '100%';

Â  Â  Â  Â  Â  Â  timer = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  timeRemaining -= 100;
Â  Â  Â  Â  Â  Â  Â  Â  const percentage = (timeRemaining / totalTime) * 100;
Â  Â  Â  Â  Â  Â  Â  Â  bar.style.width = percentage + '%';

Â  Â  Â  Â  Â  Â  Â  Â  if (timeRemaining <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitAnswer(null, []); // Time's up
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  }

Â  Â  Â  Â  function submitAnswer(chosenItem, distractors) {
Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â  // Disable buttons to prevent multiple clicks
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.choice-button').forEach(btn => btn.disabled = true);

Â  Â  Â  Â  Â  Â  const isCorrect = chosenItem && chosenItem.term === currentQuestion.term;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  processProgress(isCorrect);
Â  Â  Â  Â  Â  Â  showFeedback(isCorrect, currentQuestion, distractors, chosenItem);

Â  Â  Â  Â  Â  Â  saveState(); // Save progress after every question
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- PROGRESS MANAGEMENT ---

Â  Â  Â  Â  function processProgress(isCorrect) {
Â  Â  Â  Â  Â  Â  const item = currentQuestion;

Â  Â  Â  Â  Â  Â  if (isCorrect) {
Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount++;
Â  Â  Â  Â  Â  Â  Â  Â  if (item.level === 'New' && item.correctCount >= 3) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.level = 'Medium';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (item.level === 'Medium' && item.correctCount >= 3) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.level = 'Expert';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0; // Reset count on wrong answer
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Update the main gameData array
Â  Â  Â  Â  Â  Â  const index = gameData.findIndex(d => d.term === item.term);
Â  Â  Â  Â  Â  Â  if (index !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  gameData[index].level = item.level;
Â  Â  Â  Â  Â  Â  Â  Â  gameData[index].correctCount = item.correctCount;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function demoteTerm() {
Â  Â  Â  Â  Â  Â  const item = currentQuestion;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (item.level === 'Expert') {
Â  Â  Â  Â  Â  Â  Â  Â  item.level = 'Medium';
Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0;
Â  Â  Â  Â  Â  Â  } else if (item.level === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  item.level = 'New';Â 
Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Update the main gameData array
Â  Â  Â  Â  Â  Â  const index = gameData.findIndex(d => d.term === item.term);
Â  Â  Â  Â  Â  Â  if (index !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  gameData[index].level = item.level;
Â  Â  Â  Â  Â  Â  Â  Â  gameData[index].correctCount = 0;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  saveState();
Â  Â  Â  Â  Â  Â  goToHome(); // Go to home after demoting
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FEEDBACK SCREEN ---

Â  Â  Â  Â  function showFeedback(isCorrect, question, distractors, chosenItem) {
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 1. Message
Â  Â  Â  Â  Â  Â  const messageElement = document.getElementById('feedback-message');
Â  Â  Â  Â  Â  Â  messageElement.textContent = isCorrect ? "You are right! ğŸ‰" : "You are wrong! ğŸ˜";
Â  Â  Â  Â  Â  Â  messageElement.className = `feedback-message ${isCorrect ? 'feedback-correct' : 'feedback-wrong'}`;

Â  Â  Â  Â  Â  Â  // Handle Time's up message (Simplified)
Â  Â  Â  Â  Â  Â  if (!isCorrect && !chosenItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â messageElement.textContent = "Time's up! ğŸ˜";
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 2. Question Detail (Always Shown)
Â  Â  Â  Â  Â  Â  document.getElementById('question-feedback-image').src = question.url;
Â  Â  Â  Â  Â  Â  document.getElementById('question-feedback-term').textContent = question.term;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 3. Demote Button (STRICT CONDITION: Only Medium level AND wrong answer)
Â  Â  Â  Â  Â  Â  const demoteBtn = document.getElementById('demote-button');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (question.level === 'Medium' && !isCorrect) {
Â  Â  Â  Â  Â  Â  Â  Â  demoteBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  demoteBtn.textContent = "Study this again";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  demoteBtn.style.display = 'none'; // Hide if correct, New, or Expert
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 4. Distractor DetailsÂ 
Â  Â  Â  Â  Â  Â  const distractorDetailsContainer = document.querySelector('.distractor-details');
Â  Â  Â  Â  Â  Â  document.querySelector('.continue-button-container').style.display = 'block';

Â  Â  Â  Â  Â  Â  // Only show distractor details if we actually found 2 distractors
Â  Â  Â  Â  Â  Â  if (distractors && distractors.length === 2) {
Â  Â  Â  Â  Â  Â  Â  Â  distractorDetailsContainer.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('distractor1-image').src = distractors[0].url;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('distractor1-term').textContent = distractors[0].term;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('distractor2-image').src = distractors[1].url;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('distractor2-term').textContent = distractors[1].term;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â // Hide distractors if fewer than 2 were found
Â  Â  Â  Â  Â  Â  Â  Â  Â distractorDetailsContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  switchScreen('feedback-screen');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- INITIALIZATION ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  initializeData();
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
