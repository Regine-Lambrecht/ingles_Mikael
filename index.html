<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastery Quiz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- CSS STYLES (Mobile-First Responsive Design) --- */
        :root {
            --color-primary: #217bb8; 
            --color-secondary: #25855a; 
            --color-wrong: #e12e1c; 
            --color-bg: #ecf0f1;
            --color-text: #2c3e50;
            --color-light-text: #fefefe;
            --color-gray: #bdc3c7;
        }
        /* ADDED: General icon spacing for buttons using new FA version */
        .theme-button i, .study-again-button i {
             margin-left: 5px;
             margin-right: 0;
        }

        /* ADDED: CSS for promotion animation */
        @keyframes fadeOut {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0; transform: scale(0.9); }
        }
        .promotion-animate {
            animation: none; /* Not used anymore */
        }
        
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-bg);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #app {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            box-sizing: border-box;
            background-color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative; /* Needed for absolute positioning of exit button */
        }

        /* --- Screens --- */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .screen.active {
            display: flex;
        }

        /* --- Login Screen --- */
        /* MODIFIED: Updated styles for the new select field and button (reduced max-width) */
        #login-screen select,
        #login-screen button {
            padding: 10px;
            margin: 10px 0;
            width: 100%;
            /* MODIFIED: Reduced max-width for smaller size */
            max-width: 200px; 
            box-sizing: border-box;
            border-radius: 5px;
            /* Added margin-bottom to separate from the button */
            margin-bottom: 20px; 
        }
        #login-screen select {
            border: 1px solid var(--color-gray);
            /* Added height for better visual alignment */
            height: 40px; 
        }
        #login-screen button {
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            cursor: pointer;
        }

        /* --- Home Screen --- */
        .home-title {
            color: var(--color-primary);
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        /* New Avatar Styling */
        #user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            /* Border uses the updated color-secondary */
            border: 3px solid var(--color-primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        .theme-button {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .theme-button:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .theme-button:disabled {
            background-color: var(--color-gray);
            cursor: not-allowed;
            opacity: 0.6;
            /* MODIFIED: Change font color to var(--color-text) (#2c3e50) for better contrast */
            color: var(--color-text) !important; 
        }
        
        /* NEW: Style for the new Mastery level (Audio-to-Image) */
        .mastery-button {
            background-color: #f1c40f; /* Yellow for Mastery */
            color: var(--color-text) !important; /* Dark text for contrast */
        }
        .mastery-button:hover:not(:disabled) {
            background-color: #f39c12;
        }
        
        /* Existing styles for other levels */
        .medium-button {
            /* Now correctly uses the updated var(--color-secondary) */
            background-color: var(--color-secondary);
        }
        .medium-button:hover:not(:disabled) {
            background-color: #27ae60;
        }
        .advanced-button {
            background-color: #8e44ad; /* Purple for Advanced */
        }
        .advanced-button:hover:not(:disabled) {
            background-color: #793397;
        }
        .expert-button {
            /* Now correctly uses the updated var(--color-secondary) */
            background-color: var(--color-secondary);
        }
        .expert-button:hover:not(:disabled) {
            background-color: #27ae60;
        }


        /* MODIFIED: New styling for the logout button */
        .logout-button-styled {
            background-color: var(--color-light-text) !important; /* White BG */
            color: var(--color-primary) !important; /* Blue text */
            border: 1px solid var(--color-primary) !important; /* Blue border */
        }
        /* MODIFIED: Reverting hover behavior to avoid clash with original .study-again-button hover */
        .logout-button-styled:hover {
            background-color: var(--color-bg) !important; /* Slight grey hover */
        }

        /* ADDED: Custom Modal Button Styles for Reset Confirmation */
        .modal-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            width: 45%; /* To control button layout */
        }
        /* Primary button (Cancel - Keep progress) -> Green BG (Contrast color used) */
        #modal-cancel-btn {
            /* Now correctly uses the updated var(--color-secondary) */
            background-color: var(--color-secondary); 
            color: var(--color-light-text);
        }
        #modal-cancel-btn:focus {
            outline: 3px solid var(--color-primary);
            outline-offset: 2px;
        }
        #modal-cancel-btn:hover {
            opacity: 0.9;
        }
        /* Secondary button (Confirm - Reset progress) -> Text-like red style */
        #modal-confirm-btn {
            background-color: transparent; /* No background */
            color: var(--color-wrong); /* Red text */
            border: none;
            box-shadow: none;
        }
        #modal-confirm-btn:hover {
            opacity: 0.7;
            /* Added underline hover hint for text button */
            text-decoration: underline; 
        }
        #modal-confirm-btn:focus {
             outline: none; /* Keep the reset button looking like text even when focused */
        }


        /* MODIFIED: Reverse order of buttons in the modal for Reset on Left */
        #custom-modal-content > div {
            flex-direction: row-reverse;
        }
        /* ADDED: Style for the reset icon next to the heading */
        #modal-heading i {
             margin-right: 8px;
        }
        

        /* --- Quiz Screen / Feedback Screen Common --- */
        .exit-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--color-wrong); /* Set color to red for the times icon */
            z-index: 10;
            padding: 0; /* Ensures the button boundary is tight around the icon */
            line-height: 1; /* Ensures the icon is centered */
        }
        #question-screen h3 {
            margin-bottom: 0;
        }
        #question-image {
            max-width: 90%;
            max-height: 200px;
            width: auto;
            height: auto;
            margin: 20px 0;
            border: 1px solid var(--color-gray);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* MODIFIED: Anagram Game Specific Styles (Bigger letters and space) */
        
        /* FIX: Main wrapper uses space-between to push slot group left and button wrapper right */
        .answer-area-row {
             display: flex;
             align-items: center; 
             justify-content: space-between; /* Ensures maximum separation */
             width: 100%;
             margin: 10px 0;
        }

        .answer-slots {
            display: flex;
            flex-wrap: wrap;
            justify-content: center; 
            flex-shrink: 1; 
            margin: 0; 
            gap: 8px; 
        }
        
        /* FIX: Wrapper containing only the slots for left-side centering. 
           This container will be flex-centered inside a larger wrapper. */
        .answer-slots-container-center {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1; /* Allows it to occupy central space */
        }

        /* FIX: Wrapper for the refresh button. This wrapper ensures the button
           takes up the same space when hidden (using the spacer). */
        .refresh-button-area {
             /* Define a fixed width that matches the refresh button's visual space + margins */
             width: 40px; 
             display: flex;
             justify-content: flex-end; 
             align-items: center;
             height: 1.5em; /* Match icon height */
        }

        #reset-spelling-button {
             position: static; 
             background: none; 
             border: none;
             font-size: 1.5em; 
             cursor: pointer;
             color: var(--color-primary); 
             padding: 0;
             margin-top: 0;
             flex-shrink: 0;
        }
        .refresh-button-spacer {
             width: 100%; 
             height: 100%; 
             display: block; 
        }

        .letter-slot {
            width: 40px; 
            height: 40px; 
            line-height: 40px;
            border-bottom: 2px solid var(--color-text);
            margin: 0 4px; 
            font-size: 1.5em; 
            font-weight: bold;
            color: var(--color-text);
        }
        .letter-choices {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 10px 0;
            gap: 8px;
            width: 100%;
        }
        .letter-button {
            padding: 10px 15px; 
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            font-size: 1.3em; 
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 4px; 
        }
        .letter-button:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .letter-button:disabled {
            background-color: var(--color-gray);
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* END MODIFIED ANAGRAM STYLES */

        /* Standard Choice Buttons (Used for New/Medium levels) */
        .choice-button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .choice-button:hover {
            background-color: #2980b9;
        }
        /* End Anagram Game Specific Styles */

        /* NEW: Image Choice Layout for Mastery Level */
        #image-choices-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 10px;
            width: 100%;
        }
        .image-choice-button {
            width: 45%; /* Two images per row */
            height: 150px; /* Fixed height for consistency */
            padding: 0;
            border: 3px solid var(--color-primary);
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.2s, opacity 0.2s;
            background: white;
        }
        .image-choice-button img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .image-choice-button:hover:not(:disabled) {
            transform: scale(1.05);
            opacity: 0.9;
        }
        .image-choice-button:disabled {
            border-color: var(--color-gray);
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* End New Image Choice Layout */

        #timer-bar {
            width: 100%;
            height: 10px;
            background-color: var(--color-wrong);
            transition: width 0.1s linear;
            margin-bottom: 15px;
        }
        .timer-container {
            width: 100%;
            background-color: var(--color-gray);
            margin-bottom: 10px;
            border-radius: 5px;
            overflow: hidden;
        }

        /* --- Feedback Screen --- */
        #feedback-screen .feedback-message {
            font-size: 2em;
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .feedback-correct {
            /* Now correctly uses the updated color-secondary */
            color: var(--color-secondary);
        }
        .feedback-wrong {
            color: var(--color-wrong);
        }
        
        .main-question-area {
            margin-bottom: 15px;
        }
        .main-question-area img {
            max-width: 100%;
            max-height: 150px;
            margin: 10px 0;
            /* Border uses the updated color-secondary */
            border: 3px solid var(--color-secondary); 
            border-radius: 5px;
        }
        .main-question-area .term {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .distractor-area-wrapper {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        
        .distractor-details {
            display: flex;
            justify-content: space-around;
            flex-grow: 1;
            gap: 10px;
        }

        .distractor-item {
            flex: 1;
            padding: 5px;
            border: 1px dashed var(--color-gray);
            border-radius: 5px;
        }
        .distractor-item img {
            max-width: 100%;
            max-height: 80px;
            width: auto;
            height: auto;
            display: block;
            margin: 5px auto;
        }
        
        /* New Continue Button (Right Arrow) Style */
        .continue-button-container {
            flex-shrink: 0;
            align-self: flex-end; /* Align to the bottom of its container */
        }
        .next-button {
            padding: 15px 25px;
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            font-size: 1.5em; /* Larger icon */
            cursor: pointer;
            margin-left: 15px;
            /* Ensure icon is white */
            color: white; 
        }
        
        .study-again-button {
            padding: 8px 15px;
            background-color: var(--color-wrong);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Container for reset/logout buttons */
        .home-actions-container {
            width: 100%;
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        /* --- Loading Screen --- */
        #loading-screen {
            font-size: 1.5em;
            color: var(--color-primary);
        }
        
    </style>
</head>
<body>

    <div id="app">
        
        <div id="loading-screen" class="screen active">
            Loading data... Please wait.
        </div>

        <div id="login-screen" class="screen">
            <h2>What is your name?</h2>
            <select id="username-select">
                <option value="Mikael">Mikael</option>
                <option value="Marcia">Marcia</option>
                <option value="Mariane">Mariane</option>
                <option value="Regine">Regine</option>
            </select>
            <button onclick="attemptLogin()">Start Game</button>
            <p id="login-message" style="color: var(--color-wrong);"></p>
        </div>

        <div id="home-screen" class="screen">
            <h2 id="user-greeting" style="color: var(--color-text); margin-bottom: 5px;"></h2>
            <img id="user-avatar" src="" alt="User Avatar" style="display: none;">
            
            <h1 class="home-title">Let's study!</h1>
            <div id="theme-buttons-container" style="width: 100%;">
                <hr style="margin: 20px 0;">
                </div>
            
            <div class="home-actions-container">
                <button id="reset-button" class="study-again-button" onclick="resetProgress()">
                    Study all over again <i class="fas fa-sync-alt"></i> 
                </button>
                <button id="logout-button" class="study-again-button logout-button-styled" onclick="logout()">
                    Log Out <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div id="question-screen" class="screen">
            <button class="exit-button" onclick="goToHome()"><i class="fas fa-times"></i></button>
            <h2 id="quiz-title">What is this?</h2>
            <div class="timer-container" id="timer-container" style="display:none;">
                <div id="timer-bar"></div>
            </div>
            
                        <img id="question-image" src="" alt="Quiz Image">

                        <div class="answer-area-row"> 
                <div class="answer-slots-container-center">
                    <div id="answer-slots-container" class="answer-slots"></div>
                </div>
                
                <div class="refresh-button-area">
                    <button id="reset-spelling-button" class="exit-button" onclick="resetSpelling()" style="display: none;">
                        <i class="fas fa-redo-alt"></i>
                    </button>
                    <div id="refresh-button-spacer" class="refresh-button-spacer" style="display: block;"></div>
                </div>
            </div>
            
            <div id="letter-choices-container" class="letter-choices"></div>
                                    <div id="choices-container" style="width: 100%;">
                </div>
                        
                        <div id="image-choices-container" style="display: none;">
                            </div>
                    </div>

        <div id="feedback-screen" class="screen">
            <button class="exit-button" onclick="goToHome()"><i class="fas fa-times"></i></button>
            <h2 class="feedback-message" id="feedback-message"></h2>
            
            <div id="promotion-message" style="display:none; color:var(--color-primary); font-size:1.5em; font-weight:bold; margin-bottom:10px;"></div>
            
<div class="main-question-area">
    <img id="question-feedback-image" src="" alt="Original Question Image">
    <div class="term" id="question-feedback-term"></div>
    <button id="audio-button" class="study-again-button" style="margin-right: 10px; background-color: var(--color-primary);" onclick="playAudio()">
        Pronounce <i class="fas fa-volume-up"></i>
    </button>
    <button class="study-again-button" id="demote-button" onclick="demoteTerm()">Study this again</button>
</div>

            <div class="distractor-area-wrapper">
                <div class="distractor-details">
                    <div class="distractor-item">
                        <img id="distractor1-image" src="" alt="Distractor 1 Image">
                        <div id="distractor1-term"></div>
                    </div>
                    <div class="distractor-item">
                        <img id="distractor2-image" src="" alt="Distractor 2 Image">
                        <div id="distractor2-term"></div>
                    </div>
                </div>
                <div class="continue-button-container">
                    <button class="next-button" onclick="loadQuestion()"><i class="fas fa-step-forward"></i></button>
                </div>
            </div>

            <button id="hidden-home-button" style="display:none;" onclick="goToHome()"></button>
        </div>

    </div>

    <div id="custom-modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100;">
        <div id="custom-modal-content" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); max-width: 400px; width: 90%; text-align: center;">
            <h3 id="modal-heading" style="color:var(--color-text); margin-top:0;"><i class="fas fa-sync-alt"></i> Reset the progress counter</h3>
            <p id="modal-text">If you confirm, you will loose all your progress in the Medium, Advanced, Mastery and Expert list.</p>
            <div style="display:flex; justify-content: space-around; margin-top: 20px;">
                <button id="modal-cancel-btn" class="modal-btn">Don't reset progress</button>
                <button id="modal-confirm-btn" class="modal-btn">Reset progress anyway</button>
            </div>
        </div>
    </div>


    <script>
    /* --- JAVASCRIPT LOGIC --- */

    // --- CONFIGURATION ---
    // MODIFIED: Corrected spelling of Mariane
    const VALID_IDS = ["Mikael", "Regine", "Marcia", "Mariane"]; 
    let CURRENT_USER_ID = null; // Will store the currently logged-in user ID
    const STORAGE_PREFIX = `MasteryQuiz_State_`; // Prefix state key with user ID for segregation
    const LIST_URL = "https://regine-lambrecht.github.io/ingles_Mikael/image_list.txt";
    const BASE_IMAGE_URL = "https://regine-lambrecht.github.io/ingles_Mikael/images/";
    // NOTE: Timer remains 5 seconds as requested. Change this value to adjust duration.
    const MEDIUM_TIMER_SECONDS = 5; 

    // --- ADVANCED LEVEL STATE ---
    let currentAnswer = []; // Stores letters clicked by user
    let correctTermLetters = []; // Stores the correct term letters for comparison


    // --- STATE VARIABLES ---
    let gameData = []; // Main array of all terms
    let quizPool = []; // Terms for the current quiz session
    let currentQuizIndex = 0;
    let currentQuestion = null;
    let timer = null;
    let totalTerms = 0;
    let currentQuizLevel = null; // Stores the level selected (New, Medium, Advanced, Mastery, Expert)
    let currentQuizTheme = null;
    let uniqueThemes = new Set();
    let currentDistractors = []; // Global variable for distractors
    // Global variable to track if a promotion just occurred
    let PROMOTION_INFO = null; // Stores: { oldLevel: 'Medium', newLevel: 'Advanced' }


    // --- MODAL LOGIC (New Functions) ---

    function showCustomModal() {
        const overlay = document.getElementById('custom-modal-overlay');
        const cancelButton = document.getElementById('modal-cancel-btn');
        const confirmButton = document.getElementById('modal-confirm-btn');

        overlay.style.display = 'block';

        // Set focus to the "Don't reset progress" button
        cancelButton.focus();

        // Ensure handlers are applied only once
        confirmButton.onclick = () => handleResetConfirmation(true);
        cancelButton.onclick = () => handleResetConfirmation(false);

        // Handle Escape key to cancel (like a standard dialog)
        overlay.onkeydown = (e) => {
            if (e.key === 'Escape') {
                handleResetConfirmation(false);
            }
        };
    }

    function handleResetConfirmation(confirmed) {
        const overlay = document.getElementById('custom-modal-overlay');
        overlay.style.display = 'none';
        overlay.onkeydown = null; // Clear escape handler

        if (confirmed) {
            // Reset logic
            gameData.forEach(item => {
                item.level = 'New';
                item.correctCount = 0;
                item.failCount = 0;
            });
            saveState();
            goToHome();
        }
        // If not confirmed, do nothing (stay on home screen)
    }

    // --- UTILITY FUNCTIONS ---

    /**
     * Switches the active screen.
     * @param {string} screenId - The ID of the screen to activate.
     */
    function switchScreen(screenId) {
        // 1. Force ALL screens to hide (display: none)
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
            // ADDED SAFETY LINE: Directly hide all screens
            screen.style.display = 'none'; 
        });
        
        // 2. Activate the target screen
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
            targetScreen.classList.add('active');
            // ADDED SAFETY LINE: Directly show the target screen
            targetScreen.style.display = 'flex'; 
        }
    }

    /**
     * Loads the game state from localStorage.
     */
    function loadState() {
        if (!CURRENT_USER_ID) return;
        const STORAGE_KEY = STORAGE_PREFIX + CURRENT_USER_ID;
        try {
            const storedState = localStorage.getItem(STORAGE_KEY);
            if (storedState) {
                const savedData = JSON.parse(storedState);
                // Merge saved state into current data structure
                gameData = gameData.map(item => {
                    const savedItem = savedData.find(s => s.term === item.term);
                    if (savedItem) {
                        // MODIFIED: Check and normalize 'Listening' to 'Mastery' if needed (for legacy users)
                        let savedLevel = savedItem.level || 'New';
                        if (savedLevel === 'Listening') savedLevel = 'Mastery';
                        
                        return { 
                            ...item, 
                            level: savedLevel, 
                            correctCount: savedItem.correctCount || 0,
                            failCount: savedItem.failCount || 0 // Load fail count for Advanced demotion
                        };
                    }
                    return item;
                });
            }
        } catch (e) {
            console.error("Could not load state:", e);
            // Reset state to initial if loading fails
            gameData.forEach(item => { item.level = 'New'; item.correctCount = 0; item.failCount = 0; });
        }
    }

    /**
     * Saves the game state to localStorage.
     */
    function saveState() {
        if (!CURRENT_USER_ID) return;
        const STORAGE_KEY = STORAGE_PREFIX + CURRENT_USER_ID;
        try {
            const stateToSave = gameData.map(item => ({
                term: item.term,
                level: item.level,
                correctCount: item.correctCount,
                failCount: item.failCount || 0 // Save fail count
            }));
            localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
            console.log("State saved successfully for " + CURRENT_USER_ID);
        } catch (e) {
            console.error("Could not save state:", e);
        }
    }

    /**
     * Helper function to shuffle an array (used for anagrams/letters)
     */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    /**
     * Helper function to shuffle a string (used for anagrams)
     */
    function shuffleString(str) {
        return shuffleArray(str.split('')).join('');
    }

    /**
     * Initializes the game data by fetching the list.
     */
    async function initializeData() {
        try {
            const response = await fetch(LIST_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const text = await response.text();
            const filenames = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

            gameData = filenames.map(filename => {
                const cleanName = filename.substring(0, filename.lastIndexOf('.')).replace(/\.(?=[^.]*$)/, ''); // Remove extension
                const firstUnderscoreIndex = cleanName.indexOf('_');
                
                let theme = 'Others'; // Default theme if no underscore is found
                let term = cleanName;

                if (firstUnderscoreIndex !== -1) {
                    theme = cleanName.substring(0, firstUnderscoreIndex).trim().replace(/_/g, ' ');
                    term = cleanName.substring(firstUnderscoreIndex + 1).trim().replace(/_/g, ' ');
                } else {
                    console.warn(`Filename ${filename} does not contain an underscore. Assigned to 'Others'.`);
                }
                
                if (!theme || theme.length === 0) {
                    // Fallback in case theme parsing results in empty string
                    theme = 'Others';
                }

                const url = BASE_IMAGE_URL + filename;
                uniqueThemes.add(theme); // Collect all unique themes

                return {
                    filename,
                    url,
                    theme,
                    term,
                    level: 'New', // Default
                    correctCount: 0, // Default
                    failCount: 0 // Default
                };
            });
            
            totalTerms = gameData.length;
            switchScreen('login-screen');
        } catch (error) {
            console.error("Error loading or parsing image list:", error);
            document.getElementById('loading-screen').innerHTML = `Error loading data: ${error.message}. Check the console for details.`;
        }
    }
    
    // --- LOGIN / SESSION MANAGEMENT ---

    function attemptLogin() {
        // MODIFIED: Get selected value from the dropdown list
        const selectElement = document.getElementById('username-select');
        const input = selectElement.value.trim();
        const message = document.getElementById('login-message');

        // The list already contains the valid IDs, so no explicit check against VALID_IDS is strictly necessary.
        
        if (VALID_IDS.includes(input)) {
            CURRENT_USER_ID = input;
            loadState(); // Load state after successful login (uses ID)
            goToHome();
            message.textContent = "";
            // Console warning about local storage limitation
            console.warn("PROGRESS NOTE: Progress is saved locally in this browser only. It will not transfer to other devices or browsers.");
        } else {
            // This branch should not be reached with a dropdown.
            message.textContent = `Access denied. Please select a valid name.`;
        }
    }

    function logout() {
        saveState(); // Ensure last state is saved (uses ID)
        CURRENT_USER_ID = null;
        switchScreen('login-screen');
        // Clear the selection back to default/first option if desired (optional)
        // document.getElementById('username-select').selectedIndex = 0; 
        document.getElementById('login-message').textContent = 'Progress saved.';
    }

    // --- GAME FLOW / NAVIGATION ---

    function goToHome() {
        // 1. Set Greeting and Avatar visibility
        const greetingElement = document.getElementById('user-greeting');
        const avatarElement = document.getElementById('user-avatar');
        
        // Set Greeting for all users
        greetingElement.textContent = `Hello ${CURRENT_USER_ID}!`;

        // Check for Mikael OR Marcia and set the avatar source
        if (CURRENT_USER_ID === 'Mikael') {
            avatarElement.src = BASE_IMAGE_URL + "Mikael.png";
            avatarElement.style.display = 'block';
        } else if (CURRENT_USER_ID === 'Marcia') { 
            avatarElement.src = BASE_IMAGE_URL + "Marcia.jpg"; 
            avatarElement.style.display = 'block';
        } else {
            avatarElement.style.display = 'none';
            avatarElement.src = ''; // Clear source
        }
        
        updateHomeCounters();
        clearInterval(timer); // Stop any running timer
        switchScreen('home-screen');
    }

    // --- HOME SCREEN LOGIC ---

    function updateHomeCounters() {
        const container = document.getElementById('theme-buttons-container');
        container.innerHTML = '';

        const themeCounts = {};
        let mediumCount = 0;
        let advancedCount = 0;
        let masteryCount = 0; // NEW COUNT
        let expertCount = 0;

        // 1. Initialize counts for all known themes to 0
        uniqueThemes.forEach(theme => {
            themeCounts[theme] = 0;
        });

        // 2. Count terms by level and theme
        gameData.forEach(item => {
            if (item.level === 'New' && item.theme && item.theme.length > 0) {
                themeCounts[item.theme] = (themeCounts[item.theme] || 0) + 1;
            } else if (item.level === 'Medium') {
                mediumCount++;
            } else if (item.level === 'Advanced') {
                advancedCount++;
            } else if (item.level === 'Mastery') { // NEW LEVEL COUNT
                masteryCount++;
            } else if (item.level === 'Expert') {
                expertCount++;
            }
        });

        // 3. Inject Theme Buttons (New Level)
        Object.entries(themeCounts)
            .sort(([themeA], [themeB]) => {
                // Logic to put 'Others' last
                if (themeA === 'Others') return 1;
                if (themeB === 'Others') return -1;
                return themeA.localeCompare(themeB); // Alphabetical sort for all others
            })
            .forEach(([theme, count]) => {
                const button = document.createElement('button');
                button.className = 'theme-button';
                button.textContent = `${theme} (${count})`;
                button.onclick = () => startQuiz('New', theme);
                button.disabled = count === 0; // Disabled if count is 0
                container.appendChild(button);
            });

        // 4. Add Separator and Level Buttons
        const separator = document.createElement('hr');
        separator.style.margin = '20px 0';
        container.appendChild(separator);

        // Medium Button - MODIFIED: Add trophy icon (using fas for reliability)
        const mediumButton = document.createElement('button');
        mediumButton.id = 'medium-button';
        mediumButton.className = 'theme-button medium-button';
        mediumButton.innerHTML = `Medium (${mediumCount}) <i class="fas fa-trophy"></i>`;
        mediumButton.onclick = () => startQuiz('Medium');
        mediumButton.disabled = mediumCount === 0;
        container.appendChild(mediumButton);
        
        // Advanced Button - MODIFIED: Add two trophy icons (using fas for reliability)
        const advancedButton = document.createElement('button');
        advancedButton.id = 'advanced-button';
        advancedButton.className = 'theme-button advanced-button';
        advancedButton.innerHTML = `Advanced (${advancedCount}) <i class="fas fa-trophy"></i><i class="fas fa-trophy"></i>`;
        advancedButton.onclick = () => startQuiz('Advanced');
        advancedButton.disabled = advancedCount === 0;
        container.appendChild(advancedButton);

        // NEW: Mastery Button (Audio-to-Image)
        const masteryButton = document.createElement('button');
        masteryButton.id = 'mastery-button';
        masteryButton.className = 'theme-button mastery-button';
        masteryButton.innerHTML = `Mastery (${masteryCount}) <i class="fas fa-headphones-alt"></i>`; // Using headphones icon
        masteryButton.onclick = () => startQuiz('Mastery');
        masteryButton.disabled = masteryCount === 0;
        container.appendChild(masteryButton);


        // Expert Button - MODIFIED: Add award icon (using fas for reliability)
        const expertButton = document.createElement('button');
        expertButton.id = 'expert-button';
        expertButton.className = 'theme-button expert-button';
        expertButton.innerHTML = `Expert (${expertCount}/${totalTerms}) <i class="fas fa-award"></i>`;
        expertButton.onclick = () => startQuiz('Expert');
        expertButton.disabled = expertCount === 0;
        container.appendChild(expertButton);
    }

    /**
     * MODIFIED: Calls the custom modal for confirmation.
     */
    function resetProgress() {
        showCustomModal();
    }

    // --- QUIZ SETUP AND START ---

    function startQuiz(level, theme = null) {
        currentQuizLevel = level;
        currentQuizTheme = theme;

        // Rebuild the quiz pool based on the CURRENT state of gameData
        quizPool = gameData.filter(item => {
            if (level === 'New') {
                return item.level === 'New' && item.theme === theme;
            }
            return item.level === level;
        });

        if (quizPool.length === 0) {
            goToHome();
            return;
        }

        // Shuffle the pool to randomize question order
        quizPool.sort(() => Math.random() - 0.5);
        currentQuizIndex = 0; // Start at the beginning of the shuffled pool
        
        // Set up timer visibility
        const timerContainer = document.getElementById('timer-container');
        // Only Medium level uses the timer now
        const timerShouldBeActive = (level === 'Medium'); 

        if (timerShouldBeActive) {
            timerContainer.style.display = 'block';
        } else {
            clearInterval(timer); // Ensure timer is stopped
            timerContainer.style.display = 'none';
        }

        switchScreen('question-screen');
        loadQuestion();
    }

    // --- QUESTION HANDLING ---

    function loadQuestion() {
        // 1. Filter the quiz pool to remove promoted/demoted items
        quizPool = quizPool.filter(item => {
                    const currentState = gameData.find(d => d.term === item.term);
                    let isValid = false;
                    if (currentQuizLevel === 'New' && currentState.level === 'New' && currentState.theme === currentQuizTheme) {
                        isValid = true;
                    } else if (currentQuizLevel === 'Medium' && currentState.level === 'Medium') {
                        isValid = true;
                    } else if (currentQuizLevel === 'Advanced' && currentState.level === 'Advanced') {
                        isValid = true;
                    } else if (currentQuizLevel === 'Mastery' && currentState.level === 'Mastery') { // NEW LEVEL CHECK
                        isValid = true;
                    } else if (currentQuizLevel === 'Expert' && currentState.level === 'Expert') {
                        isValid = true;
                    }
                    return isValid;
        });

        if (quizPool.length === 0) {
            goToHome();
            return;
        }

        // Select the next question
        let itemIndex = currentQuizIndex % quizPool.length;
        currentQuestion = gameData.find(item => item.term === quizPool[itemIndex].term);

        const level = currentQuestion.level;
        const questionImage = document.getElementById('question-image');
        const choicesContainer = document.getElementById('choices-container');
        const slotsContainer = document.getElementById('answer-slots-container');
        const letterContainer = document.getElementById('letter-choices-container');
        const imageChoicesContainer = document.getElementById('image-choices-container'); // NEW CONTAINER

        // Reset UI for the new question
        slotsContainer.innerHTML = '';
        letterContainer.innerHTML = '';
        choicesContainer.innerHTML = '';
        imageChoicesContainer.innerHTML = ''; // NEW RESET
        currentAnswer = [];
        
        // Show/Hide refresh button for Advanced level only
        const refreshButton = document.getElementById('reset-spelling-button');
        const refreshSpacer = document.getElementById('refresh-button-spacer'); // Get the spacer
        
        // Hide everything by default, then show only what's needed
        questionImage.style.display = 'none';
        choicesContainer.style.display = 'none';
        slotsContainer.style.display = 'none';
        letterContainer.style.display = 'none';
        imageChoicesContainer.style.display = 'none';
        refreshButton.style.display = 'none';
        refreshSpacer.style.display = 'block'; 

        // 2. Expert level is just review
        if (level === 'Expert') {
            showExpertReview();
            currentQuizIndex++; 
            currentDistractors = []; // Clear currentDistractors for Expert level
            return;
        }


        // 3. Mastery Level: Audio-to-Image Choice (NEW MODE)
        if (level === 'Mastery') {
            document.getElementById('quiz-title').textContent = "Which image matches the word?";
            imageChoicesContainer.style.display = 'flex';
            
            // 3a. Get Distractors
            // For Mastery, get 2 distractors from Advanced, Medium, or New
            const distractors = getDistractors(level, currentQuestion, 2); // Only need 2 distractors for the 3 image choices
            currentDistractors = distractors; 

            // 3b. Render Image Choices (2 distractors + 1 correct)
            renderImageQuizChoices(currentQuestion, currentDistractors);
            
            // 3c. Start Audio Playback
            playAudio(currentQuestion.term);


        } else if (level === 'Advanced') {
            // Advanced Level: Interactive Spelling
            questionImage.style.display = 'block';
            questionImage.src = currentQuestion.url;
            slotsContainer.style.display = 'flex';
            letterContainer.style.display = 'flex';
            document.getElementById('quiz-title').textContent = "Spell the word:";

            // Show refresh button
            refreshButton.style.display = 'block';
            refreshSpacer.style.display = 'none'; // Hide spacer

            // Start the Interactive Spelling Game
            renderSpellingGame(currentQuestion);
            currentDistractors = []; // Clear currentDistractors for Advanced level

        } else {
            // New / Medium Level: Standard Multiple Choice
            questionImage.style.display = 'block';
            questionImage.src = currentQuestion.url;
            choicesContainer.style.display = 'block';
            document.getElementById('quiz-title').textContent = "What is this?";

            // 3. Get Distractors (only needed for New/Medium)
            const distractors = getDistractors(level, currentQuestion);
            currentDistractors = distractors; // Store distractors globally

            // 4. Render standard multiple choice
            renderQuizChoices(currentQuestion, distractors);
        }


        // 5. Start Timer
        // Only Medium level starts the timer here
        if (level === 'Medium') {
            startTimer();
        } else {
            clearInterval(timer);
        }
        
        // 6. Advance the index
        currentQuizIndex++; 
        if (currentQuizIndex >= quizPool.length && quizPool.length > 0) {
            // Re-shuffle and reset index if we've cycled through all available questions
            quizPool.sort(() => Math.random() - 0.5);
            currentQuizIndex = 0;
        }
        
        switchScreen('question-screen');
    }

    /**
     * Logic to find distractors for various levels.
     * @param {string} level - The current quiz level ('New', 'Medium', 'Mastery').
     * @param {object} question - The correct question item.
     * @param {number} count - The number of distractors needed (default 2).
     */
    function getDistractors(level, question, count = 2) {
        const distractors = [];
        let availableTerms = [];
        
        if (level === 'New') {
            // For 'New', prioritize other 'New' terms within the SAME theme
            availableTerms = gameData.filter(item => 
                item.level === 'New' && item.theme === question.theme && item.term !== question.term
            );
        } 
        
        // SECONDARY POOL: All 'New' terms globally for New/Medium/Mastery fallback.
        if (level === 'Medium' || level === 'Mastery' || availableTerms.length < count) {
            const globalPool = gameData.filter(item => 
                item.term !== question.term && item.level === 'New'
            );
            
            availableTerms = globalPool.slice(); 
        }
        
        // Draw initial distractors from the available pool
        availableTerms.sort(() => Math.random() - 0.5); 
        
        while (distractors.length < count && availableTerms.length > 0) {
            distractors.push(availableTerms.pop());
        }

        // TERTIARY POOL: Fallback to ANY other term if still missing distractors
        if (distractors.length < count) {
            const allOtherTerms = gameData.filter(item => item.term !== question.term && 
                                            !distractors.some(d => d.term === item.term));
            allOtherTerms.sort(() => Math.random() - 0.5);
            while (distractors.length < count && allOtherTerms.length > 0) {
                distractors.push(allOtherTerms.pop());
            }
        }
        return distractors;
    }
    
    /**
     * Renders standard multiple choice buttons (New and Medium levels).
     */
    function renderQuizChoices(question, distractors) {
        const choicesContainer = document.getElementById('choices-container');
        
        const choices = [question, ...distractors];
        choices.sort(() => Math.random() - 0.5); // Randomize button order

        choices.forEach(item => {
            const button = document.createElement('button');
            button.className = 'choice-button';
            button.textContent = item.term;
            // Note: Distractors array is passed empty for advanced, but here it's real
            button.onclick = () => submitAnswer(item, currentDistractors); 
            choicesContainer.appendChild(button);
        });
    }

    /**
     * NEW: Renders image choices for the Mastery level.
     */
    function renderImageQuizChoices(question, distractors) {
        const container = document.getElementById('image-choices-container');
        
        // Combine correct answer and distractors (total 3 items: 1 correct, 2 distractors)
        const choices = [question, ...distractors];
        choices.sort(() => Math.random() - 0.5); // Randomize button order
        
        choices.forEach(item => {
            const button = document.createElement('button');
            button.className = 'image-choice-button';
            // Store the term on the button for comparison in submitAnswer
            button.dataset.term = item.term; 
            
            const image = document.createElement('img');
            image.src = item.url;
            image.alt = item.term;
            button.appendChild(image);
            
            // Use an event listener to capture the selected term for submission
            button.onclick = (e) => {
                // Stop audio feedback if it's still running
                window.speechSynthesis.cancel(); 
                
                // Find the corresponding item from gameData using the term in the dataset
                const chosenItem = gameData.find(d => d.term === button.dataset.term);
                submitAnswer(chosenItem, currentDistractors);
            };
            
            container.appendChild(button);
        });
    }


    /**
     * Renders the interactive spelling game (Advanced level).
     */
    function renderSpellingGame(question) {
        const slotsContainer = document.getElementById('answer-slots-container');
        const letterContainer = document.getElementById('letter-choices-container');
        
        // 1. Prepare correct term (Remove spaces and capitalize for consistency)
        const cleanTerm = question.term.replace(/\s/g, '').toUpperCase(); 
        correctTermLetters = cleanTerm.split('');

        // 2. Create answer slots
        correctTermLetters.forEach((letter, index) => {
            const slot = document.createElement('div');
            slot.className = 'letter-slot';
            slot.id = `slot-${index}`;
            slotsContainer.appendChild(slot);
        });

        // 3. Create shuffled letter buttons
        const shuffledLetters = shuffleArray(correctTermLetters.slice()); // Clone and shuffle
        
        shuffledLetters.forEach((letter, index) => {
            const button = document.createElement('button');
            button.className = 'letter-button';
            button.textContent = letter;
            button.dataset.letter = letter;
            button.dataset.index = index; // Use unique index for tracking
            button.onclick = () => clickLetter(button);
            letterContainer.appendChild(button);
        });
    }
    
    /**
     * ADDED: Resets the current spelling attempt in the Advanced level.
     */
    function resetSpelling() {
        // Re-enable all letter buttons
