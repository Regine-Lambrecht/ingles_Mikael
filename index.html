<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Mastery Quiz</title>
Â  Â  <style>
Â  Â  Â  Â  /* --- CSS STYLES (Mobile-First Responsive Design) --- */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --color-primary: #3498db;
Â  Â  Â  Â  Â  Â  --color-secondary: #2ecc71;
Â  Â  Â  Â  Â  Â  --color-wrong: #e74c3c;
Â  Â  Â  Â  Â  Â  --color-bg: #ecf0f1;
Â  Â  Â  Â  Â  Â  --color-text: #2c3e50;
Â  Â  Â  Â  Â  Â  --color-light-text: #fefefe;
Â  Â  Â  Â  Â  Â  --color-gray: #bdc3c7;
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: sans-serif;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  background-color: var(--color-bg);
Â  Â  Â  Â  Â  Â  color: var(--color-text);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  }

Â  Â  Â  Â  #app {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  Â  Â  position: relative; /* Needed for absolute positioning of exit button */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Screens --- */
Â  Â  Â  Â  .screen {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .screen.active {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Login Screen --- */
Â  Â  Â  Â  #login-screen input[type="text"],
Â  Â  Â  Â  #login-screen button {
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  margin: 10px 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 300px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #login-screen input[type="text"] {
Â  Â  Â  Â  Â  Â  border: 1px solid var(--color-gray);
Â  Â  Â  Â  }
Â  Â  Â  Â  #login-screen button {
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);
Â  Â  Â  Â  Â  Â  color: var(--color-light-text);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Home Screen --- */
Â  Â  Â  Â  .home-title {
Â  Â  Â  Â  Â  Â  color: var(--color-primary);
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  font-size: 1.8em;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* New Avatar Styling */
Â  Â  Â  Â  #user-avatar {
Â  Â  Â  Â  Â  Â  width: 80px;
Â  Â  Â  Â  Â  Â  height: 80px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  object-fit: cover;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  border: 3px solid var(--color-primary);
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
Â  Â  Â  Â  }

Â  Â  Â  Â  .theme-button {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  margin: 8px 0;
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);
Â  Â  Â  Â  Â  Â  color: var(--color-light-text);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .theme-button:hover:not(:disabled) {
Â  Â  Â  Â  Â  Â  background-color: #2980b9;
Â  Â  Â  Â  }
Â  Â  Â  Â  .theme-button:disabled {
Â  Â  Â  Â  Â  Â  background-color: var(--color-gray);
Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  }
Â  Â  Â  Â  .medium-button, .expert-button {
Â  Â  Â  Â  Â  Â  background-color: var(--color-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .medium-button:hover:not(:disabled), .expert-button:hover:not(:disabled) {
Â  Â  Â  Â  Â  Â  background-color: #27ae60;
Â  Â  Â  Â  }
Â  Â  Â  Â  .advanced-button {
Â  Â  Â  Â  Â  Â  background-color: #8e44ad; /* Purple for Advanced */
Â  Â  Â  Â  }
Â  Â  Â  Â  .advanced-button:hover:not(:disabled) {
Â  Â  Â  Â  Â  Â  background-color: #793397;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Quiz Screen / Feedback Screen Common --- */
Â  Â  Â  Â  .exit-button {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 20px;
Â  Â  Â  Â  Â  Â  left: 20px;
Â  Â  Â  Â  Â  Â  background: none;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  font-size: 1.5em;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  color: var(--color-wrong);
Â  Â  Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  }
Â  Â  Â  Â  #question-screen h3 {
Â  Â  Â  Â  Â  Â  margin-bottom: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  #question-image {
Â  Â  Â  Â  Â  Â  max-width: 90%;
Â  Â  Â  Â  Â  Â  max-height: 200px;
Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  Â  Â  margin: 20px 0;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--color-gray);
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Anagram Game Specific Styles */
Â  Â  Â  Â  .answer-slots, .letter-choices {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  margin: 10px 0;
Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .letter-slot {
Â  Â  Â  Â  Â  Â  width: 30px;
Â  Â  Â  Â  Â  Â  height: 30px;
Â  Â  Â  Â  Â  Â  line-height: 30px;
Â  Â  Â  Â  Â  Â  border-bottom: 2px solid var(--color-text);
Â  Â  Â  Â  Â  Â  margin: 0 2px;
Â  Â  Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: var(--color-text);
Â  Â  Â  Â  }
Â  Â  Â  Â  .letter-button {
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);
Â  Â  Â  Â  Â  Â  color: var(--color-light-text);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  Â  Â  Â  margin: 2px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .letter-button:hover:not(:disabled) {
Â  Â  Â  Â  Â  Â  background-color: #2980b9;
Â  Â  Â  Â  }
Â  Â  Â  Â  .letter-button:disabled {
Â  Â  Â  Â  Â  Â  background-color: var(--color-gray);
Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Standard Choice Buttons (Used for New/Medium levels) */
Â  Â  Â  Â  .choice-button {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  Â  Â  margin: 5px 0;
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);
Â  Â  Â  Â  Â  Â  color: var(--color-light-text);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .choice-button:hover {
Â  Â  Â  Â  Â  Â  background-color: #2980b9;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* End Anagram Game Specific Styles */

Â  Â  Â  Â  #timer-bar {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 10px;
Â  Â  Â  Â  Â  Â  background-color: var(--color-wrong);
Â  Â  Â  Â  Â  Â  transition: width 0.1s linear;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .timer-container {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  background-color: var(--color-gray);
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Feedback Screen --- */
Â  Â  Â  Â  #feedback-screen .feedback-message {
Â  Â  Â  Â  Â  Â  font-size: 2em;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .feedback-correct {
Â  Â  Â  Â  Â  Â  color: var(--color-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .feedback-wrong {
Â  Â  Â  Â  Â  Â  color: var(--color-wrong);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .main-question-area {
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .main-question-area img {
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  Â  Â  max-height: 150px;
Â  Â  Â  Â  Â  Â  margin: 10px 0;
Â  Â  Â  Â  Â  Â  border: 3px solid var(--color-secondary);
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .main-question-area .term {
Â  Â  Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .distractor-area-wrapper {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .distractor-details {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-around;
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .distractor-item {
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  Â  border: 1px dashed var(--color-gray);
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .distractor-item img {
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  Â  Â  max-height: 80px;
Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin: 5px auto;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* New Continue Button (Right Arrow) Style */
Â  Â  Â  Â  .continue-button-container {
Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  Â  Â  align-self: flex-end; /* Align to the bottom of its container */
Â  Â  Â  Â  }
Â  Â  Â  Â  .next-button {
Â  Â  Â  Â  Â  Â  padding: 15px 25px;
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);
Â  Â  Â  Â  Â  Â  color: var(--color-light-text);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  font-size: 1.5em; /* Larger arrow */
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  margin-left: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .study-again-button {
Â  Â  Â  Â  Â  Â  padding: 8px 15px;
Â  Â  Â  Â  Â  Â  background-color: var(--color-wrong);
Â  Â  Â  Â  Â  Â  color: var(--color-light-text);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Container for reset/logout buttons */
Â  Â  Â  Â  .home-actions-container {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-around;
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Loading Screen --- */
Â  Â  Â  Â  #loading-screen {
Â  Â  Â  Â  Â  Â  font-size: 1.5em;
Â  Â  Â  Â  Â  Â  color: var(--color-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  </style>
</head>
<body>

Â  Â  <div id="app">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="loading-screen" class="screen active">
Â  Â  Â  Â  Â  Â  Loading data... Please wait.
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="login-screen" class="screen">
Â  Â  Â  Â  Â  Â  <h2>What is your name?</h2>
Â  Â  Â  Â  Â  Â  <input type="text" id="username-input">
Â  Â  Â  Â  Â  Â  <button onclick="attemptLogin()">Start Game</button>
Â  Â  Â  Â  Â  Â  <p id="login-message" style="color: var(--color-wrong);"></p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="home-screen" class="screen">
Â  Â  Â  Â  Â  Â  <h2 id="user-greeting" style="color: var(--color-text); margin-bottom: 5px;"></h2>
Â  Â  Â  Â  Â  Â  <img id="user-avatar" src="" alt="User Avatar" style="display: none;">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <h1 class="home-title">Let's study!</h1>
Â  Â  Â  Â  Â  Â  <div id="theme-buttons-container" style="width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  <hr style="margin: 20px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="home-actions-container">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="reset-button" class="study-again-button" onclick="resetProgress()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Study all over again ğŸ”„
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="logout-button" class="study-again-button" style="background-color: var(--color-gray);" onclick="logout()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Log Out
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="question-screen" class="screen">
Â  Â  Â  Â  Â  Â  <button class="exit-button" onclick="goToHome()">âŒ</button>
Â  Â  Â  Â  Â  Â  <h2 id="quiz-title">What is this?</h2>
Â  Â  Â  Â  Â  Â  <div class="timer-container" id="timer-container" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="timer-bar"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <img id="question-image" src="" alt="Quiz Image">

Â  Â  Â  Â  Â  Â  <div id="answer-slots-container" class="answer-slots"></div>
Â  Â  Â  Â  Â  Â  <div id="letter-choices-container" class="letter-choices"></div>
Â  Â  Â  Â  Â  Â  <div id="choices-container" style="width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="feedback-screen" class="screen">
Â  Â  Â  Â  Â  Â  <button class="exit-button" onclick="goToHome()">âŒ</button>
Â  Â  Â  Â  Â  Â  <h2 class="feedback-message" id="feedback-message"></h2>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="main-question-area">
Â  Â  Â  Â  Â  Â  Â  Â  <img id="question-feedback-image" src="" alt="Original Question Image">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="term" id="question-feedback-term"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="study-again-button" id="demote-button" onclick="demoteTerm()">Study this again</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="distractor-area-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="distractor-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="distractor-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="distractor1-image" src="" alt="Distractor 1 Image">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="distractor1-term"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="distractor-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="distractor2-image" src="" alt="Distractor 2 Image">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="distractor2-term"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="continue-button-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="next-button" onclick="loadQuestion()">â–¶ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <button id="hidden-home-button" style="display:none;" onclick="goToHome()"></button>
Â  Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  /* --- JAVASCRIPT LOGIC --- */

Â  Â  Â  Â  // --- CONFIGURATION ---
Â  Â  Â  Â  // UPDATED: Added Marcia and Mariane
Â  Â  Â  Â  const VALID_IDS = ["Mikael", "Regine", "Marcia", "Mariane"];Â 
Â  Â  Â  Â  let CURRENT_USER_ID = null; // Will store the currently logged-in user ID
Â  Â  Â  Â  const STORAGE_PREFIX = `MasteryQuiz_State_`; // Prefix state key with user ID for segregation
Â  Â  Â  Â  const LIST_URL = "https://regine-lambrecht.github.io/ingles_Mikael/image_list.txt";
Â  Â  Â  Â  const BASE_IMAGE_URL = "https://regine-lambrecht.github.io/ingles_Mikael/images/";
Â  Â  Â  Â  const MEDIUM_TIMER_SECONDS = 5;

Â  Â  Â  Â  // --- ADVANCED LEVEL STATE ---
Â  Â  Â  Â  let currentAnswer = []; // Stores letters clicked by user
Â  Â  Â  Â  let correctTermLetters = []; // Stores the correct term letters for comparison


Â  Â  Â  Â  // --- STATE VARIABLES ---
Â  Â  Â  Â  let gameData = []; // Main array of all terms
Â  Â  Â  Â  let quizPool = []; // Terms for the current quiz session
Â  Â  Â  Â  let currentQuizIndex = 0;
Â  Â  Â  Â  let currentQuestion = null;
Â  Â  Â  Â  let timer = null;
Â  Â  Â  Â  let totalTerms = 0;
Â  Â  Â  Â  let currentQuizLevel = null; // Stores the level selected (New, Medium, Advanced, Expert)
Â  Â  Â  Â  let currentQuizTheme = null;
Â  Â  Â  Â  let uniqueThemes = new Set();
Â  Â  Â  Â  // FIX: New global variable to store the exact distractors used in the question
Â  Â  Â  Â  let currentDistractors = [];


Â  Â  Â  Â  // --- UTILITY FUNCTIONS ---

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Switches the active screen.
Â  Â  Â  Â  Â * @param {string} screenId - The ID of the screen to activate.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function switchScreen(screenId) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.screen').forEach(screen => {
Â  Â  Â  Â  Â  Â  Â  Â  screen.classList.remove('active');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById(screenId).classList.add('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Loads the game state from localStorage.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function loadState() {
Â  Â  Â  Â  Â  Â  if (!CURRENT_USER_ID) return;
Â  Â  Â  Â  Â  Â  const STORAGE_KEY = STORAGE_PREFIX + CURRENT_USER_ID;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const storedState = localStorage.getItem(STORAGE_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  if (storedState) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedData = JSON.parse(storedState);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Merge saved state into current data structure
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameData = gameData.map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedItem = savedData.find(s => s.term === item.term);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (savedItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let savedLevel = savedItem.level || 'New';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...item,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  level: savedLevel,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctCount: savedItem.correctCount || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  failCount: savedItem.failCount || 0 // Load fail count for Advanced demotion
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return item;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Could not load state:", e);
Â  Â  Â  Â  Â  Â  Â  Â  // Reset state to initial if loading fails
Â  Â  Â  Â  Â  Â  Â  Â  gameData.forEach(item => { item.level = 'New'; item.correctCount = 0; item.failCount = 0; });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Saves the game state to localStorage.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function saveState() {
Â  Â  Â  Â  Â  Â  if (!CURRENT_USER_ID) return;
Â  Â  Â  Â  Â  Â  const STORAGE_KEY = STORAGE_PREFIX + CURRENT_USER_ID;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const stateToSave = gameData.map(item => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  term: item.term,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  level: item.level,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctCount: item.correctCount,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  failCount: item.failCount || 0 // Save fail count
Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
Â  Â  Â  Â  Â  Â  Â  Â  console.log("State saved successfully for " + CURRENT_USER_ID);
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Could not save state:", e);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Helper function to shuffle an array (used for anagrams/letters)
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function shuffleArray(array) {
Â  Â  Â  Â  Â  Â  for (let i = array.length - 1; i > 0; i--) {
Â  Â  Â  Â  Â  Â  Â  Â  const j = Math.floor(Math.random() * (i + 1));
Â  Â  Â  Â  Â  Â  Â  Â  [array[i], array[j]] = [array[j], array[i]];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return array;
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Helper function to shuffle a string (used for anagrams)
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function shuffleString(str) {
Â  Â  Â  Â  Â  Â  return shuffleArray(str.split('')).join('');
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Initializes the game data by fetching the list.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function initializeData() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(LIST_URL);
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  const text = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  const filenames = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

Â  Â  Â  Â  Â  Â  Â  Â  gameData = filenames.map(filename => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cleanName = filename.substring(0, filename.lastIndexOf('.')).replace(/\.(?=[^.]*$)/, ''); // Remove extension
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const firstUnderscoreIndex = cleanName.indexOf('_');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let theme = 'Others'; // Default theme if no underscore is found
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let term = cleanName;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (firstUnderscoreIndex !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  theme = cleanName.substring(0, firstUnderscoreIndex).trim().replace(/_/g, ' ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  term = cleanName.substring(firstUnderscoreIndex + 1).trim().replace(/_/g, ' ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Filename ${filename} does not contain an underscore. Assigned to 'Others'.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!theme || theme.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fallback in case theme parsing results in empty string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  theme = 'Others';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const url = BASE_IMAGE_URL + filename;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uniqueThemes.add(theme); // Collect all unique themes

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  filename,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  url,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  theme,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  term,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  level: 'New', // Default
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctCount: 0, // Default
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  failCount: 0 // Default
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  totalTerms = gameData.length;
Â  Â  Â  Â  Â  Â  Â  Â  switchScreen('login-screen');
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error loading or parsing image list:", error);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loading-screen').innerHTML = `Error loading data: ${error.message}. Check the console for details.`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- LOGIN / SESSION MANAGEMENT ---

Â  Â  Â  Â  function attemptLogin() {
Â  Â  Â  Â  Â  Â  const input = document.getElementById('username-input').value.trim();
Â  Â  Â  Â  Â  Â  const message = document.getElementById('login-message');

Â  Â  Â  Â  Â  Â  if (VALID_IDS.includes(input)) {
Â  Â  Â  Â  Â  Â  Â  Â  CURRENT_USER_ID = input;
Â  Â  Â  Â  Â  Â  Â  Â  loadState(); // Load state after successful login (uses ID)
Â  Â  Â  Â  Â  Â  Â  Â  goToHome();
Â  Â  Â  Â  Â  Â  Â  Â  message.textContent = "";
Â  Â  Â  Â  Â  Â  Â  Â  // Console warning about local storage limitation
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("PROGRESS NOTE: Progress is saved locally in this browser only. It will not transfer to other devices or browsers.");
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  message.textContent = `Access denied. Valid IDs are: ${VALID_IDS.join(', ')}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function logout() {
Â  Â  Â  Â  Â  Â  saveState(); // Ensure last state is saved (uses ID)
Â  Â  Â  Â  Â  Â  CURRENT_USER_ID = null;
Â  Â  Â  Â  Â  Â  switchScreen('login-screen');
Â  Â  Â  Â  Â  Â  document.getElementById('username-input').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('login-message').textContent = 'Progress saved.';
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- GAME FLOW / NAVIGATION ---

Â  Â  Â  Â  function goToHome() {
Â  Â  Â  Â  Â  Â  // 1. Set Greeting and Avatar visibility
Â  Â  Â  Â  Â  Â  const greetingElement = document.getElementById('user-greeting');
Â  Â  Â  Â  Â  Â  const avatarElement = document.getElementById('user-avatar');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Set Greeting for all users
Â  Â  Â  Â  Â  Â  greetingElement.textContent = `Hello ${CURRENT_USER_ID}!`;

Â  Â  Â  Â  Â  Â  if (CURRENT_USER_ID === 'Mikael') {
Â  Â  Â  Â  Â  Â  Â  Â  avatarElement.src = BASE_IMAGE_URL + "Mikael.png";
Â  Â  Â  Â  Â  Â  Â  Â  avatarElement.style.display = 'block';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  avatarElement.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  avatarElement.src = ''; // Clear source
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  updateHomeCounters();
Â  Â  Â  Â  Â  Â  clearInterval(timer); // Stop any running timer
Â  Â  Â  Â  Â  Â  switchScreen('home-screen');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- HOME SCREEN LOGIC ---

Â  Â  Â  Â  function updateHomeCounters() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('theme-buttons-container');
Â  Â  Â  Â  Â  Â  container.innerHTML = '';

Â  Â  Â  Â  Â  Â  const themeCounts = {};
Â  Â  Â  Â  Â  Â  let mediumCount = 0;
Â  Â  Â  Â  Â  Â  let advancedCount = 0;
Â  Â  Â  Â  Â  Â  let expertCount = 0;

Â  Â  Â  Â  Â  Â  // 1. Initialize counts for all known themes to 0
Â  Â  Â  Â  Â  Â  uniqueThemes.forEach(theme => {
Â  Â  Â  Â  Â  Â  Â  Â  themeCounts[theme] = 0;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 2. Count terms by level and theme
Â  Â  Â  Â  Â  Â  gameData.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  if (item.level === 'New' && item.theme && item.theme.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  themeCounts[item.theme] = (themeCounts[item.theme] || 0) + 1;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (item.level === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mediumCount++;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (item.level === 'Advanced') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  advancedCount++;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (item.level === 'Expert') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  expertCount++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 3. Inject Theme Buttons (New Level)
Â  Â  Â  Â  Â  Â  Object.entries(themeCounts)
Â  Â  Â  Â  Â  Â  Â  Â  .sort(([themeA], [themeB]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Logic to put 'Others' last
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (themeA === 'Others') return 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (themeB === 'Others') return -1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return themeA.localeCompare(themeB); // Alphabetical sort for all others
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .forEach(([theme, count]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.className = 'theme-button';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.textContent = `${theme} (${count})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.onclick = () => startQuiz('New', theme);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.disabled = count === 0; // Disabled if count is 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(button);
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 4. Add Separator and Level Buttons
Â  Â  Â  Â  Â  Â  const separator = document.createElement('hr');
Â  Â  Â  Â  Â  Â  separator.style.margin = '20px 0';
Â  Â  Â  Â  Â  Â  container.appendChild(separator);

Â  Â  Â  Â  Â  Â  // Medium Button
Â  Â  Â  Â  Â  Â  const mediumButton = document.createElement('button');
Â  Â  Â  Â  Â  Â  mediumButton.id = 'medium-button';
Â  Â  Â  Â  Â  Â  mediumButton.className = 'theme-button medium-button';
Â  Â  Â  Â  Â  Â  mediumButton.textContent = `Medium (${mediumCount})`;
Â  Â  Â  Â  Â  Â  mediumButton.onclick = () => startQuiz('Medium');
Â  Â  Â  Â  Â  Â  mediumButton.disabled = mediumCount === 0;
Â  Â  Â  Â  Â  Â  container.appendChild(mediumButton);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Advanced Button
Â  Â  Â  Â  Â  Â  const advancedButton = document.createElement('button');
Â  Â  Â  Â  Â  Â  advancedButton.id = 'advanced-button';
Â  Â  Â  Â  Â  Â  advancedButton.className = 'theme-button advanced-button';
Â  Â  Â  Â  Â  Â  advancedButton.textContent = `Advanced (${advancedCount})`;
Â  Â  Â  Â  Â  Â  advancedButton.onclick = () => startQuiz('Advanced');
Â  Â  Â  Â  Â  Â  advancedButton.disabled = advancedCount === 0;
Â  Â  Â  Â  Â  Â  container.appendChild(advancedButton);


Â  Â  Â  Â  Â  Â  // Expert Button
Â  Â  Â  Â  Â  Â  const expertButton = document.createElement('button');
Â  Â  Â  Â  Â  Â  expertButton.id = 'expert-button';
Â  Â  Â  Â  Â  Â  expertButton.className = 'theme-button expert-button';
Â  Â  Â  Â  Â  Â  expertButton.textContent = `Expert (${expertCount}/${totalTerms})`;
Â  Â  Â  Â  Â  Â  expertButton.onclick = () => startQuiz('Expert');
Â  Â  Â  Â  Â  Â  expertButton.disabled = expertCount === 0;
Â  Â  Â  Â  Â  Â  container.appendChild(expertButton);
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Resets all terms back to the 'New' level.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function resetProgress() {
Â  Â  Â  Â  Â  Â  if (confirm("Are you sure you want to reset all progress? All terms will be set back to the 'New' level.")) {
Â  Â  Â  Â  Â  Â  Â  Â  gameData.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.level = 'New';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.failCount = 0; // Reset fail count
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  saveState(); // Save the reset state
Â  Â  Â  Â  Â  Â  Â  Â  goToHome(); // Refresh the home screen counters
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- QUIZ SETUP AND START ---

Â  Â  Â  Â  function startQuiz(level, theme = null) {
Â  Â  Â  Â  Â  Â  currentQuizLevel = level;
Â  Â  Â  Â  Â  Â  currentQuizTheme = theme;

Â  Â  Â  Â  Â  Â  // Rebuild the quiz pool based on the CURRENT state of gameData
Â  Â  Â  Â  Â  Â  quizPool = gameData.filter(item => {
Â  Â  Â  Â  Â  Â  Â  Â  if (level === 'New') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return item.level === 'New' && item.theme === theme;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return item.level === level;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (quizPool.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  goToHome();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Shuffle the pool to randomize question order
Â  Â  Â  Â  Â  Â  quizPool.sort(() => Math.random() - 0.5);
Â  Â  Â  Â  Â  Â  currentQuizIndex = 0; // Start at the beginning of the shuffled pool
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Set up timer visibility
Â  Â  Â  Â  Â  Â  const timerContainer = document.getElementById('timer-container');
Â  Â  Â  Â  Â  Â  // Only Medium level uses the timer now
Â  Â  Â  Â  Â  Â  const timerShouldBeActive = (level === 'Medium');Â 

Â  Â  Â  Â  Â  Â  if (timerShouldBeActive) {
Â  Â  Â  Â  Â  Â  Â  Â  timerContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(timer); // Ensure timer is stopped
Â  Â  Â  Â  Â  Â  Â  Â  timerContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  switchScreen('question-screen');
Â  Â  Â  Â  Â  Â  loadQuestion();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- QUESTION HANDLING ---

Â  Â  Â  Â  function loadQuestion() {
Â  Â  Â  Â  Â  Â  // 1. Filter the quiz pool to remove promoted/demoted items
Â  Â  Â  Â  Â  Â  quizPool = quizPool.filter(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const currentState = gameData.find(d => d.term === item.term);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â let isValid = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (currentQuizLevel === 'New' && currentState.level === 'New' && currentState.theme === currentQuizTheme) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isValid = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else if (currentQuizLevel === 'Medium' && currentState.level === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isValid = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else if (currentQuizLevel === 'Advanced' && currentState.level === 'Advanced') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isValid = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else if (currentQuizLevel === 'Expert' && currentState.level === 'Expert') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isValid = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return isValid;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (quizPool.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  goToHome();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Select the next question
Â  Â  Â  Â  Â  Â  let itemIndex = currentQuizIndex % quizPool.length;
Â  Â  Â  Â  Â  Â  currentQuestion = gameData.find(item => item.term === quizPool[itemIndex].term);

Â  Â  Â  Â  Â  Â  const level = currentQuestion.level;
Â  Â  Â  Â  Â  Â  const questionImage = document.getElementById('question-image');
Â  Â  Â  Â  Â  Â  const choicesContainer = document.getElementById('choices-container');
Â  Â  Â  Â  Â  Â  const slotsContainer = document.getElementById('answer-slots-container');
Â  Â  Â  Â  Â  Â  const letterContainer = document.getElementById('letter-choices-container');

Â  Â  Â  Â  Â  Â  // Reset UI for the new question
Â  Â  Â  Â  Â  Â  slotsContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  letterContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  choicesContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  currentAnswer = [];
Â  Â  Â  Â  Â  Â  // Reset the distractors for the new question cycle
Â  Â  Â  Â  Â  Â  currentDistractors = []; // Global reset


Â  Â  Â  Â  Â  Â  // 2. Expert level is just review
Â  Â  Â  Â  Â  Â  if (level === 'Expert') {
Â  Â  Â  Â  Â  Â  Â  Â  showExpertReview();
Â  Â  Â  Â  Â  Â  Â  Â  currentQuizIndex++;Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Show/Hide elements based on level
Â  Â  Â  Â  Â  Â  if (level === 'Advanced') {
Â  Â  Â  Â  Â  Â  Â  Â  // Advanced Level: Interactive Spelling
Â  Â  Â  Â  Â  Â  Â  Â  questionImage.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  questionImage.src = currentQuestion.url;
Â  Â  Â  Â  Â  Â  Â  Â  choicesContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  slotsContainer.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  letterContainer.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('quiz-title').textContent = "Spell the word:";

Â  Â  Â  Â  Â  Â  Â  Â  // Start the Interactive Spelling Game
Â  Â  Â  Â  Â  Â  Â  Â  renderSpellingGame(currentQuestion);

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // New / Medium Level: Standard Multiple Choice
Â  Â  Â  Â  Â  Â  Â  Â  questionImage.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  questionImage.src = currentQuestion.url;
Â  Â  Â  Â  Â  Â  Â  Â  choicesContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  slotsContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  letterContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('quiz-title').textContent = "What is this?";

Â  Â  Â  Â  Â  Â  Â  Â  // 3. Get Distractors (only needed for New/Medium)
Â  Â  Â  Â  Â  Â  Â  Â  const distractors = getDistractors(level, currentQuestion);
Â  Â  Â  Â  Â  Â  Â  Â  // FIX: Store the distractors for use in the feedback screen later
Â  Â  Â  Â  Â  Â  Â  Â  currentDistractors = distractors;

Â  Â  Â  Â  Â  Â  Â  Â  // 4. Render standard multiple choice
Â  Â  Â  Â  Â  Â  Â  Â  renderQuizChoices(currentQuestion, distractors);
Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  // 5. Start Timer
Â  Â  Â  Â  Â  Â  // Only Medium level starts the timer here
Â  Â  Â  Â  Â  Â  if (level === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  startTimer();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 6. Advance the index
Â  Â  Â  Â  Â  Â  currentQuizIndex++;Â 
Â  Â  Â  Â  Â  Â  if (currentQuizIndex >= quizPool.length && quizPool.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  // Re-shuffle and reset index if we've cycled through all available questions
Â  Â  Â  Â  Â  Â  Â  Â  quizPool.sort(() => Math.random() - 0.5);
Â  Â  Â  Â  Â  Â  Â  Â  currentQuizIndex = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  switchScreen('question-screen');
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Logic to find distractors for New/Medium levels.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function getDistractors(level, question) {
Â  Â  Â  Â  Â  Â  const distractors = [];
Â  Â  Â  Â  Â  Â  let availableTerms = [];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (level === 'New') {
Â  Â  Â  Â  Â  Â  Â  Â  // For 'New', prioritize other 'New' terms within the SAME theme
Â  Â  Â  Â  Â  Â  Â  Â  availableTerms = gameData.filter(item =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.level === 'New' && item.theme === question.theme && item.term !== question.term
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // SECONDARY POOL: All 'New' terms globally.
Â  Â  Â  Â  Â  Â  if (level === 'Medium' || availableTerms.length < 2) {
Â  Â  Â  Â  Â  Â  Â  Â  const globalPool = gameData.filter(item =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.term !== question.term && item.level === 'New'
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  availableTerms = globalPool.slice();Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Draw initial distractors from the available pool
Â  Â  Â  Â  Â  Â  availableTerms.sort(() => Math.random() - 0.5);Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  while (distractors.length < 2 && availableTerms.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  distractors.push(availableTerms.pop());
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // TERTIARY POOL: Fallback to ANY other term if still missing distractors
Â  Â  Â  Â  Â  Â  if (distractors.length < 2) {
Â  Â  Â  Â  Â  Â  Â  Â  const allOtherTerms = gameData.filter(item => item.term !== question.term &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  !distractors.some(d => d.term === item.term));
Â  Â  Â  Â  Â  Â  Â  Â  allOtherTerms.sort(() => Math.random() - 0.5);
Â  Â  Â  Â  Â  Â  Â  Â  while (distractors.length < 2 && allOtherTerms.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  distractors.push(allOtherTerms.pop());
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return distractors;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Renders standard multiple choice buttons (New and Medium levels).
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function renderQuizChoices(question, distractors) {
Â  Â  Â  Â  Â  Â  const choicesContainer = document.getElementById('choices-container');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const choices = [question, ...distractors];
Â  Â  Â  Â  Â  Â  choices.sort(() => Math.random() - 0.5); // Randomize button order

Â  Â  Â  Â  Â  Â  choices.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  button.className = 'choice-button';
Â  Â  Â  Â  Â  Â  Â  Â  button.textContent = item.term;
Â  Â  Â  Â  Â  Â  Â  Â  // The distractors variable is passed here, ensuring the same set used for buttons
Â  Â  Â  Â  Â  Â  Â  Â  button.onclick = () => submitAnswer(item, distractors);Â 
Â  Â  Â  Â  Â  Â  Â  Â  choicesContainer.appendChild(button);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Renders the interactive spelling game (Advanced level).
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function renderSpellingGame(question) {
Â  Â  Â  Â  Â  Â  const slotsContainer = document.getElementById('answer-slots-container');
Â  Â  Â  Â  Â  Â  const letterContainer = document.getElementById('letter-choices-container');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 1. Prepare correct term (Remove spaces and capitalize for consistency)
Â  Â  Â  Â  Â  Â  const cleanTerm = question.term.replace(/\s/g, '').toUpperCase();Â 
Â  Â  Â  Â  Â  Â  correctTermLetters = cleanTerm.split('');

Â  Â  Â  Â  Â  Â  // 2. Create answer slots
Â  Â  Â  Â  Â  Â  correctTermLetters.forEach((letter, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const slot = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  slot.className = 'letter-slot';
Â  Â  Â  Â  Â  Â  Â  Â  slot.id = `slot-${index}`;
Â  Â  Â  Â  Â  Â  Â  Â  slotsContainer.appendChild(slot);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 3. Create shuffled letter buttons
Â  Â  Â  Â  Â  Â  const shuffledLetters = shuffleArray(correctTermLetters.slice()); // Clone and shuffle
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  shuffledLetters.forEach((letter, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  button.className = 'letter-button';
Â  Â  Â  Â  Â  Â  Â  Â  button.textContent = letter;
Â  Â  Â  Â  Â  Â  Â  Â  button.dataset.letter = letter;
Â  Â  Â  Â  Â  Â  Â  Â  button.dataset.index = index; // Use unique index for tracking
Â  Â  Â  Â  Â  Â  Â  Â  button.onclick = () => clickLetter(button);
Â  Â  Â  Â  Â  Â  Â  Â  letterContainer.appendChild(button);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Handles the user clicking a letter button.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function clickLetter(button) {
Â  Â  Â  Â  Â  Â  const slots = document.getElementById('answer-slots-container').children;
Â  Â  Â  Â  Â  Â  const currentIndex = currentAnswer.length;

Â  Â  Â  Â  Â  Â  if (currentIndex < correctTermLetters.length) {
Â  Â  Â  Â  Â  Â  Â  Â  const letter = button.dataset.letter;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Fill the current open slot
Â  Â  Â  Â  Â  Â  Â  Â  slots[currentIndex].textContent = letter;
Â  Â  Â  Â  Â  Â  Â  Â  currentAnswer.push(letter);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 2. Disable the clicked button
Â  Â  Â  Â  Â  Â  Â  Â  button.disabled = true;

Â  Â  Â  Â  Â  Â  Â  Â  // 3. Check if the word is complete
Â  Â  Â  Â  Â  Â  Â  Â  if (currentAnswer.length === correctTermLetters.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checkAnswer();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Compares the user's input with the correct answer.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function checkAnswer() {
Â  Â  Â  Â  Â  Â  const userAnswer = currentAnswer.join('');
Â  Â  Â  Â  Â  Â  const correctAnswer = correctTermLetters.join('');
Â  Â  Â  Â  Â  Â  const isCorrect = userAnswer === correctAnswer;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Visually mark slots green/red (optional but helpful)
Â  Â  Â  Â  Â  Â  const slots = document.getElementById('answer-slots-container').children;
Â  Â  Â  Â  Â  Â  for(let i = 0; i < slots.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  slots[i].style.color = isCorrect ? 'var(--color-secondary)' : 'var(--color-wrong)';
Â  Â  Â  Â  Â  Â  Â  Â  slots[i].style.borderBottomColor = isCorrect ? 'var(--color-secondary)' : 'var(--color-wrong)';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Submit with the globally stored distractors
Â  Â  Â  Â  Â  Â  submitAnswer(isCorrect ? currentQuestion : null, currentDistractors);Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function showExpertReview() {
Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('feedback-message').textContent = "Review: Expert";
Â  Â  Â  Â  Â  Â  document.getElementById('feedback-message').className = 'feedback-message';

Â  Â  Â  Â  Â  Â  // Display question details
Â  Â  Â  Â  Â  Â  document.getElementById('question-feedback-image').src = currentQuestion.url;
Â  Â  Â  Â  Â  Â  document.getElementById('question-feedback-image').style.display = 'block';
Â  Â  Â  Â  Â  Â  document.getElementById('question-feedback-term').textContent = currentQuestion.term;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Hide distractor details as there was no quiz
Â  Â  Â  Â  Â  Â  document.querySelector('.distractor-details').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.querySelector('.continue-button-container').style.display = 'block';


Â  Â  Â  Â  Â  Â  // Show demote button (allows demotion from Expert for revision)
Â  Â  Â  Â  Â  Â  const demoteBtn = document.getElementById('demote-button');
Â  Â  Â  Â  Â  Â  demoteBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  demoteBtn.textContent = "Demote to Advanced";Â 

Â  Â  Â  Â  Â  Â  switchScreen('feedback-screen');
Â  Â  Â  Â  }

Â  Â  Â  Â  function startTimer() {
Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â  const totalTime = MEDIUM_TIMER_SECONDS * 1000;
Â  Â  Â  Â  Â  Â  let timeRemaining = totalTime;
Â  Â  Â  Â  Â  Â  const bar = document.getElementById('timer-bar');

Â  Â  Â  Â  Â  Â  bar.style.width = '100%';

Â  Â  Â  Â  Â  Â  timer = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  timeRemaining -= 100;
Â  Â  Â  Â  Â  Â  Â  Â  const percentage = (timeRemaining / totalTime) * 100;
Â  Â  Â  Â  Â  Â  Â  Â  bar.style.width = percentage + '%';

Â  Â  Â  Â  Â  Â  Â  Â  if (timeRemaining <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Disable letters/choices on timeout
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.letter-button, .choice-button').forEach(btn => btn.disabled = true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Only Medium level needs special handling for timeout submission
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentQuizLevel === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // For Medium, submit wrong answer (null chosen item) using the stored distractors
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitAnswer(null, currentDistractors);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  }

Â  Â  Â  Â  function submitAnswer(chosenItem, distractors) {
Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â  // Disable all buttons immediately after submission or timeout
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.letter-button, .choice-button').forEach(btn => btn.disabled = true);

Â  Â  Â  Â  Â  Â  // Determine if the answer was correct (handles both standard quiz and spelling)
Â  Â  Â  Â  Â  Â  const isCorrect = chosenItem && chosenItem.term === currentQuestion.term;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  processProgress(isCorrect);
Â  Â  Â  Â  Â  Â  // Pass the correct list of distractors to showFeedback
Â  Â  Â  Â  Â  Â  showFeedback(isCorrect, currentQuestion, distractors, chosenItem);

Â  Â  Â  Â  Â  Â  saveState(); // Save progress after every question
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- PROGRESS MANAGEMENT ---

Â  Â  Â  Â  function processProgress(isCorrect) {
Â  Â  Â  Â  Â  Â  const item = currentQuestion;
Â  Â  Â  Â  Â  Â  const currentLevel = item.level;

Â  Â  Â  Â  Â  Â  if (isCorrect) {
Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount++;
Â  Â  Â  Â  Â  Â  Â  Â  item.failCount = 0; // Reset fail count on success
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (currentLevel === 'New' && item.correctCount >= 3) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.level = 'Medium';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (currentLevel === 'Medium' && item.correctCount >= 3) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.level = 'Advanced';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (currentLevel === 'Advanced' && item.correctCount >= 3) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.level = 'Expert'; // Promote Advanced to Expert
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Wrong answer / Time's up
Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0; // Reset correct count immediately
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (currentLevel === 'Advanced') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.failCount = (item.failCount || 0) + 1; // Track consecutive fails
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.failCount >= 3) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.level = 'Medium'; // Demote Advanced to Medium
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.failCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Reset fail count for other levels if not used for demotion
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.failCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Update the main gameData array
Â  Â  Â  Â  Â  Â  const index = gameData.findIndex(d => d.term === item.term);
Â  Â  Â  Â  Â  Â  if (index !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  gameData[index].level = item.level;
Â  Â  Â  Â  Â  Â  Â  Â  gameData[index].correctCount = item.correctCount;
Â  Â  Â  Â  Â  Â  Â  Â  gameData[index].failCount = item.failCount || 0;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function demoteTerm() {
Â  Â  Â  Â  Â  Â  const item = currentQuestion;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (item.level === 'Expert') {
Â  Â  Â  Â  Â  Â  Â  Â  item.level = 'Advanced'; // Demote from Expert to Advanced
Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0;
Â  Â  Â  Â  Â  Â  } else if (item.level === 'Advanced') {
Â  Â  Â  Â  Â  Â  Â  Â  item.level = 'Medium'; // Demote from Advanced to Medium
Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0;
Â  Â  Â  Â  Â  Â  } else if (item.level === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  item.level = 'New';Â 
Â  Â  Â  Â  Â  Â  Â  Â  item.correctCount = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Update the main gameData array
Â  Â  Â  Â  Â  Â  const index = gameData.findIndex(d => d.term === item.term);
Â  Â  Â  Â  Â  Â  if (index !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  gameData[index].level = item.level;
Â  Â  Â  Â  Â  Â  Â  Â  gameData[index].correctCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  gameData[index].failCount = 0; // Reset fail count on manual demotion
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  saveState();
Â  Â  Â  Â  Â  Â  goToHome(); // Go to home after demoting
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FEEDBACK SCREEN ---

Â  Â  Â  Â  function showFeedback(isCorrect, question, distractors, chosenItem) {
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 1. Message
Â  Â  Â  Â  Â  Â  const messageElement = document.getElementById('feedback-message');
Â  Â  Â  Â  Â  Â  messageElement.textContent = isCorrect ? "You are right! ğŸ‰" : "You are wrong! ğŸ˜";
Â  Â  Â  Â  Â  Â  messageElement.className = `feedback-message ${isCorrect ? 'feedback-correct' : 'feedback-wrong'}`;

Â  Â  Â  Â  Â  Â  // Only show "Time's up" if the quiz was running at Medium level and failedÂ 
Â  Â  Â  Â  Â  Â  // due to null answer (timeout). Advanced level's null answer is a wrong submission.
Â  Â  Â  Â  Â  Â  if (!isCorrect && !chosenItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (currentQuizLevel === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â messageElement.textContent = "Time's up! ğŸ˜";
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â // If it's Advanced, the message remains "You are wrong! ğŸ˜", which is correct.
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 2. Question Detail (Always Shown)
Â  Â  Â  Â  Â  Â  document.getElementById('question-feedback-image').src = question.url;
Â  Â  Â  Â  Â  Â  document.getElementById('question-feedback-term').textContent = question.term;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Show image if it was hidden for Advanced level
Â  Â  Â  Â  Â  Â  document.getElementById('question-feedback-image').style.display = 'block';

Â  Â  Â  Â  Â  Â  // 3. Demote Button
Â  Â  Â  Â  Â  Â  const demoteBtn = document.getElementById('demote-button');
Â  Â  Â  Â  Â  Â  const currentLevel = question.level;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // The logic here is based on the state *before* any promotion/demotion that might have just happened.
Â  Â  Â  Â  Â  Â  // We need to find the item's current state in the gameData array, as it may have been promoted/demoted already.
Â  Â  Â  Â  Â  Â  const updatedItem = gameData.find(d => d.term === question.term);
Â  Â  Â  Â  Â  Â  const updatedLevel = updatedItem ? updatedItem.level : currentLevel;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Demote button is available only if the *updated* level is not 'New' AND the answer was wrong.
Â  Â  Â  Â  Â  Â  // It's also available for Expert review.
Â  Â  Â  Â  Â  Â  if (updatedLevel === 'Expert') {
Â  Â  Â  Â  Â  Â  Â  Â  Â demoteBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â demoteBtn.textContent = "Demote to Advanced";
Â  Â  Â  Â  Â  Â  } else if (updatedLevel === 'Advanced' && !isCorrect) {
Â  Â  Â  Â  Â  Â  Â  Â  Â demoteBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â demoteBtn.textContent = "Study this again (Demote to Medium)";
Â  Â  Â  Â  Â  Â  } else if (updatedLevel === 'Medium' && !isCorrect) {
Â  Â  Â  Â  Â  Â  Â  Â  Â demoteBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â demoteBtn.textContent = "Study this again (Demote to New)";
Â  Â  Â  Â  Â  Â  } else if (currentLevel === 'New' && !isCorrect) {
Â  Â  Â  Â  Â  Â  Â  Â  Â // Manual demotion is not applicable on 'New' items, but we keep the button hidden.
Â  Â  Â  Â  Â  Â  Â  Â  Â demoteBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â demoteBtn.style.display = 'none'; // Hide if correct or the level changed below the point of manual demotion
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 4. Distractor DetailsÂ 
Â  Â  Â  Â  Â  Â  const distractorDetailsContainer = document.querySelector('.distractor-details');
Â  Â  Â  Â  Â  Â  document.querySelector('.continue-button-container').style.display = 'block';

Â  Â  Â  Â  Â  Â  // Distractor details are only relevant for New/Medium quizzes
Â  Â  Â  Â  Â  Â  if (currentLevel === 'New' || currentLevel === 'Medium') {
Â  Â  Â  Â  Â  Â  Â  Â  distractorDetailsContainer.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // FIX: Use the *GLOBAL* currentDistractors for the display logic
Â  Â  Â  Â  Â  Â  Â  Â  const relevantDistractors = currentDistractors; 

Â  Â  Â  Â  Â  Â  Â  Â  // Set Distractor 1
Â  Â  Â  Â  Â  Â  Â  Â  if (relevantDistractors[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('distractor1-image').src = relevantDistractors[0].url;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('distractor1-term').textContent = relevantDistractors[0].term;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('.distractor-item:nth-child(1)').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('.distractor-item:nth-child(1)').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Set Distractor 2
Â  Â  Â  Â  Â  Â  Â  Â  if (relevantDistractors[1]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('distractor2-image').src = relevantDistractors[1].url;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('distractor2-term').textContent = relevantDistractors[1].term;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('.distractor-item:nth-child(2)').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('.distractor-item:nth-child(2)').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â // Hide distractors for Advanced and Expert
Â  Â  Â  Â  Â  Â  Â  Â  Â distractorDetailsContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  switchScreen('feedback-screen');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- INITIALIZATION ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  initializeData();
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
