<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastery Quiz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- CSS STYLES (Mobile-First Responsive Design) --- */
        :root {
            --color-primary: #217bb8; 
            --color-secondary: #25855a; 
            --color-wrong: #e12e1c; 
            --color-bg: #ecf0f1;
            --color-text: #2c3e50;
            --color-light-text: #fefefe;
            --color-gray: #bdc3c7;
        }
        /* ADDED: General icon spacing for buttons using new FA version */
        .theme-button i, .study-again-button i {
             margin-left: 5px;
             margin-right: 0;
        }

        /* ADDED: CSS for promotion animation */
        @keyframes fadeOut {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0; transform: scale(0.9); }
        }
        .promotion-animate {
            animation: none; /* Not used anymore */
        }
        
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-bg);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #app {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            box-sizing: border-box;
            background-color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative; /* Needed for absolute positioning of exit button */
        }

        /* --- Screens --- */
        .screen {
            display: none; /* Default hidden state */
            flex-direction: column; /* Ensure content stacks vertically */
            align-items: center; /* Center horizontally */
            text-align: center;
        }
        .screen.active {
            display: flex !important; /* Force visibility and flex layout */
        }

        /* --- Login Screen --- */
        #login-screen select,
        #login-screen button {
            padding: 10px;
            margin: 10px 0;
            width: 100%;
            max-width: 200px; 
            box-sizing: border-box;
            border-radius: 5px;
            margin-bottom: 20px; 
        }
        #login-screen select {
            border: 1px solid var(--color-gray);
            height: 40px; 
        }
        #login-screen button {
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            cursor: pointer;
        }

        /* --- Home Screen --- */
        .home-title {
            color: var(--color-primary);
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        /* New Avatar Styling */
        #user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 3px solid var(--color-primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        .theme-button {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .theme-button:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .theme-button:disabled {
            background-color: var(--color-gray);
            cursor: not-allowed;
            opacity: 0.6;
            color: var(--color-text) !important; 
        }
        .medium-button, .expert-button {
            background-color: var(--color-secondary);
        }
        .medium-button:hover:not(:disabled), .expert-button:hover:not(:disabled) {
            background-color: #27ae60;
        }
        .advanced-button {
            background-color: #8e44ad; /* Purple for Advanced */
        }
        .advanced-button:hover:not(:disabled) {
            background-color: #793397;
        }

        /* MODIFIED: New styling for the logout button */
        .logout-button-styled {
            background-color: var(--color-light-text) !important; /* White BG */
            color: var(--color-primary) !important; /* Blue text */
            border: 1px solid var(--color-primary) !important; /* Blue border */
        }
        /* MODIFIED: Reverting hover behavior to avoid clash with original .study-again-button hover */
        .logout-button-styled:hover {
            background-color: var(--color-bg) !important; /* Slight grey hover */
        }

        /* ADDED: Custom Modal Button Styles for Reset Confirmation */
        .modal-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            width: 45%; /* To control button layout */
        }
        /* Primary button (Cancel - Keep progress) -> Green BG (Contrast color used) */
        #modal-cancel-btn {
            background-color: var(--color-secondary); 
            color: var(--color-light-text);
        }
        #modal-cancel-btn:focus {
            outline: 3px solid var(--color-primary);
            outline-offset: 2px;
        }
        #modal-cancel-btn:hover {
            opacity: 0.9;
        }
        /* Secondary button (Confirm - Reset progress) -> Text-like red style */
        #modal-confirm-btn {
            background-color: transparent; /* No background */
            color: var(--color-wrong); /* Red text */
            border: none;
            box-shadow: none;
        }
        #modal-confirm-btn:hover {
            opacity: 0.7;
            /* Added underline hover hint for text button */
            text-decoration: underline; 
        }
        #modal-confirm-btn:focus {
             outline: none; /* Keep the reset button looking like text even when focused */
        }


        /* MODIFIED: Reverse order of buttons in the modal for Reset on Left */
        #custom-modal-content > div {
            flex-direction: row-reverse;
        }
        /* ADDED: Style for the reset icon next to the heading */
        #modal-heading i {
             margin-right: 8px;
        }
        

        /* --- Quiz Screen / Feedback Screen Common --- */
        .exit-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--color-wrong); /* Set color to red for the times icon */
            z-index: 10;
            padding: 0; /* Ensures the button boundary is tight around the icon */
            line-height: 1; /* Ensures the icon is centered */
        }
        #question-screen h3 {
            margin-bottom: 0;
        }
        #question-image {
            max-width: 90%;
            max-height: 200px;
            width: auto;
            height: auto;
            margin: 20px 0;
            border: 1px solid var(--color-gray);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* MODIFIED: Anagram Game Specific Styles (Bigger letters and space) */
        
        /* FIX: Main wrapper uses space-between to push slot group left and button wrapper right */
        .answer-area-row {
             display: flex;
             align-items: center; 
             justify-content: space-between; /* Ensures maximum separation */
             width: 100%;
             margin: 10px 0;
        }

        .answer-slots {
            display: flex;
            flex-wrap: wrap;
            justify-content: center; 
            flex-shrink: 1; 
            margin: 0; 
            gap: 8px; 
        }
        
        /* FIX: Wrapper containing only the slots for left-side centering. 
           This container will be flex-centered inside a larger wrapper. */
        .answer-slots-container-center {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1; /* Allows it to occupy central space */
        }

        /* FIX: Wrapper for the refresh button. This wrapper ensures the button
           takes up the same space when hidden (using the spacer). */
        .refresh-button-area {
             /* Define a fixed width that matches the refresh button's visual space + margins */
             width: 40px; 
             display: flex;
             justify-content: flex-end; 
             align-items: center;
             height: 1.5em; /* Match icon height */
        }

        #reset-spelling-button {
             position: static; 
             background: none; 
             border: none;
             font-size: 1.5em; 
             cursor: pointer;
             color: var(--color-primary); 
             padding: 0;
             margin-top: 0;
             flex-shrink: 0;
        }
        .refresh-button-spacer {
             width: 100%; 
             height: 100%; 
             display: block; 
        }

        .letter-slot {
            width: 40px; 
            height: 40px; 
            line-height: 40px;
            border-bottom: 2px solid var(--color-text);
            margin: 0 4px; 
            font-size: 1.5em; 
            font-weight: bold;
            color: var(--color-text);
        }
        .letter-choices {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 10px 0;
            gap: 8px;
            width: 100%;
        }
        .letter-button {
            padding: 10px 15px; 
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            font-size: 1.3em; 
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 4px; 
        }
        .letter-button:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .letter-button:disabled {
            background-color: var(--color-gray);
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* END MODIFIED ANAGRAM STYLES */

        /* Standard Choice Buttons (Used for New/Intermediate levels) */
        .choice-button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .choice-button:hover {
            background-color: #2980b9;
        }
        
        /* Timer styles */
        #timer-bar {
            width: 100%;
            height: 10px;
            background-color: var(--color-wrong);
            transition: width 0.1s linear;
            margin-bottom: 15px;
        }
        .timer-container {
            width: 100%;
            background-color: var(--color-gray);
            margin-bottom: 10px;
            border-radius: 5px;
            overflow: hidden;
        }

        /* --- Feedback Screen --- */
        #feedback-screen .feedback-message {
            font-size: 2em;
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .feedback-correct {
            color: var(--color-secondary);
        }
        .feedback-wrong {
            color: var(--color-wrong);
        }
        
        .main-question-area {
            margin-bottom: 15px;
        }
        .main-question-area img {
            max-width: 100%;
            max-height: 150px;
            margin: 10px 0;
            border: 3px solid var(--color-secondary); 
            border-radius: 5px;
        }
        .main-question-area .term {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .distractor-area-wrapper {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }
        
        .distractor-details {
            display: flex;
            justify-content: space-around;
            flex-grow: 1;
            gap: 10px;
        }

        .distractor-item {
            flex: 1;
            padding: 5px;
            border: 1px dashed var(--color-gray);
            border-radius: 5px;
        }
        .distractor-item img {
            max-width: 100%;
            max-height: 80px;
            width: auto;
            height: auto;
            display: block;
            margin: 5px auto;
        }
        
        /* New Continue Button (Right Arrow) Style */
        .continue-button-container {
            flex-shrink: 0;
            align-self: flex-end; /* Align to the bottom of its container */
        }
        .next-button {
            padding: 15px 25px;
            background-color: var(--color-primary);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            font-size: 1.5em; /* Larger icon */
            cursor: pointer;
            margin-left: 15px;
            color: white; 
        }
        
        .study-again-button {
            padding: 8px 15px;
            background-color: var(--color-wrong);
            color: var(--color-light-text);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Container for reset/logout buttons */
        .home-actions-container {
            width: 100%;
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        /* --- Loading Screen --- */
        #loading-screen {
            font-size: 1.5em;
            color: var(--color-primary);
        }
        
    </style>
</head>
<body>

    <div id="app">
        
                <div id="loading-screen" class="screen">
            Loading data... Please wait.
        </div>

        <div id="login-screen" class="screen">
            <h2>What is your name?</h2>
            <select id="username-select">
                <option value="Mikael">Mikael</option>
                <option value="Marcia">Marcia</option>
                <option value="Mariane">Mariane</option>
                <option value="Regine">Regine</option>
            </select>
            <button onclick="attemptLogin()">Start Game</button>
            <p id="login-message" style="color: var(--color-wrong);"></p>
        </div>

        <div id="home-screen" class="screen">
            <h2 id="user-greeting" style="color: var(--color-text); margin-bottom: 5px;"></h2>
            <img id="user-avatar" src="" alt="User Avatar" style="display: none;">
            
            <h1 class="home-title">Let's study!</h1>
            <div id="theme-buttons-container" style="width: 100%;">
                <hr style="margin: 20px 0;">
                </div>
            
            <div class="home-actions-container">
                <button id="reset-button" class="study-again-button" onclick="resetProgress()">
                    Study all over again <i class="fas fa-sync-alt"></i> 
                </button>
                <button id="logout-button" class="study-again-button logout-button-styled" onclick="logout()">
                    Log Out <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div id="question-screen" class="screen">
            <button class="exit-button" onclick="goToHome()"><i class="fas fa-times"></i></button>
            <h2 id="quiz-title">What is this?</h2>
            <div class="timer-container" id="timer-container" style="display:none;">
                <div id="timer-bar"></div>
            </div>
            <img id="question-image" src="" alt="Quiz Image">

            <div class="answer-area-row"> 
                <div class="answer-slots-container-center">
                    <div id="answer-slots-container" class="answer-slots"></div>
                </div>
                
                <div class="refresh-button-area">
                    <button id="reset-spelling-button" class="exit-button" onclick="resetSpelling()" style="display: none;">
                        <i class="fas fa-redo-alt"></i>
                    </button>
                    <div id="refresh-button-spacer" class="refresh-button-spacer" style="display: block;"></div>
                </div>
            </div>
            
            <div id="letter-choices-container" class="letter-choices"></div>
            <div id="choice-buttons-container" style="width: 100%;">
                </div>
            <div id="image-choices-container" class="distractor-details" style="display: none; width: 100%; margin-top: 15px;">
                            </div>
        </div>

        <div id="feedback-screen" class="screen">
            <button class="exit-button" onclick="goToHome()"><i class="fas fa-times"></i></button>
            <h2 class="feedback-message" id="feedback-message"></h2>
            
            <div id="promotion-message" style="display:none; color:var(--color-primary); font-size:1.5em; font-weight:bold; margin-bottom:10px;"></div>
            
            <div class="main-question-area">
                <img id="question-feedback-image" src="" alt="Original Question Image">
                <div class="term" id="question-feedback-term"></div>
                <button id="audio-button" class="study-again-button" style="margin-right: 10px; background-color: var(--color-primary);" onclick="playAudio()">
                    Pronounce <i class="fas fa-volume-up"></i>
                </button>
                <button class="study-again-button" id="demote-button" onclick="demoteTerm()">Study this again</button>
            </div>

            <div class="distractor-area-wrapper">
                <div class="distractor-details">
                    <div class="distractor-item">
                        <img id="distractor1-image" src="" alt="Distractor 1 Image">
                        <div id="distractor1-term"></div>
                    </div>
                    <div class="distractor-item">
                        <img id="distractor2-image" src="" alt="Distractor 2 Image">
                        <div id="distractor2-term"></div>
                    </div>
                </div>
                <div class="continue-button-container">
                    <button class="next-button" onclick="loadQuestion()"><i class="fas fa-step-forward"></i></button>
                </div>
            </div>

            <button id="hidden-home-button" style="display:none;" onclick="goToHome()"></button>
        </div>

    </div>

    <div id="custom-modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100;">
        <div id="custom-modal-content" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); max-width: 400px; width: 90%; text-align: center;">
            <h3 id="modal-heading" style="color:var(--color-text); margin-top:0;"><i class="fas fa-sync-alt"></i> Reset the progress counter</h3>
            <p id="modal-text">If you confirm, you will loose all your progress in the Intermediate, Advanced, Expert, and Master lists.</p>
            <div style="display:flex; justify-content: space-around; margin-top: 20px;">
                <button id="modal-cancel-btn" class="modal-btn">Don't reset progress</button>
                <button id="modal-confirm-btn" class="modal-btn">Reset progress anyway</button>
            </div>
        </div>
      </div>


    <script>
        /* --- JAVASCRIPT LOGIC --- */

        // --- CONFIGURATION ---
        const VALID_IDS = ["Mikael", "Regine", "Marcia", "Mariane"]; 
        let CURRENT_USER_ID = null; 
        const STORAGE_PREFIX = `MasteryQuiz_State_`; 
        const LIST_URL = "https://regine-lambrecht.github.io/ingles_Mikael/image_list.txt";
        const BASE_IMAGE_URL = "https://regine-lambrecht.github.io/ingles_Mikael/images/";
        const MEDIUM_TIMER_SECONDS = 5; 

        // --- LEVEL DEFINITIONS (UPDATED) ---
        const LEVELS = {
            'New': { count: 3, promoteTo: 'Intermediate', buttonClass: '' },
            'Intermediate': { count: 3, promoteTo: 'Advanced', buttonClass: 'medium-button' },
            'Advanced': { count: 3, demoteTo: 'Intermediate', promoteTo: 'Expert', buttonClass: 'advanced-button' },
            'Expert': { count: 3, promoteTo: 'Master', demoteTo: 'Advanced', buttonClass: 'expert-button' }, 
            'Master': { count: 0, buttonClass: 'expert-button' }
        };
        const LEVEL_ORDER = ['New', 'Intermediate', 'Advanced', 'Expert', 'Master'];

        // --- ADVANCED LEVEL STATE ---
        let currentAnswer = []; 
        let correctTermLetters = []; 


        // --- STATE VARIABLES ---
        let gameData = []; 
        let quizPool = []; 
        let currentQuizIndex = 0;
        let currentQuestion = null;
        let timer = null;
        let totalTerms = 0;
        let currentQuizLevel = null;
        let currentQuizTheme = null;
        let uniqueThemes = new Set();
        let currentDistractors = []; 
        let PROMOTION_INFO = null; 


        // --- MODAL LOGIC ---

        function showCustomModal() {
            const overlay = document.getElementById('custom-modal-overlay');
            const cancelButton = document.getElementById('modal-cancel-btn');
            const confirmButton = document.getElementById('modal-confirm-btn');

            overlay.style.display = 'block';

            cancelButton.focus();

            confirmButton.onclick = () => handleResetConfirmation(true);
            cancelButton.onclick = () => handleResetConfirmation(false);

            overlay.onkeydown = (e) => {
                if (e.key === 'Escape') {
                    handleResetConfirmation(false);
                }
            };
        }

        function handleResetConfirmation(confirmed) {
            const overlay = document.getElementById('custom-modal-overlay');
            overlay.style.display = 'none';
            overlay.onkeydown = null; 

            if (confirmed) {
                // Reset logic
                gameData.forEach(item => {
                    item.level = 'New';
                    item.correctCount = 0;
                    item.failCount = 0;
                });
                saveState();
                goToHome();
            }
        }

        // --- UTILITY FUNCTIONS ---

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.style.display = 'none'; // Ensure all are hidden
                screen.classList.remove('active'); // Remove active class
            });
            // Show the target screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                 targetScreen.style.display = 'flex';
                 targetScreen.classList.add('active');
            }
           
        }

        /**
         * Loads the game state from localStorage, handling level renames.
         */
        function loadState() {
            if (!CURRENT_USER_ID) return;
            const STORAGE_KEY = STORAGE_PREFIX + CURRENT_USER_ID;
            try {
                const storedState = localStorage.getItem(STORAGE_KEY);
                if (storedState) {
                    const savedData = JSON.parse(storedState);
                    
                    // Helper to map old level names to new level names
                    const mapOldLevel = (oldLevel) => {
                        if (oldLevel === 'Medium') return 'Intermediate';
                        if (oldLevel === 'Expert') return 'Master'; // Old Expert -> New Master
                        return oldLevel;
                    };

                    gameData = gameData.map(item => {
                        const savedItem = savedData.find(s => s.term === item.term);
                        if (savedItem) {
                            let savedLevel = mapOldLevel(savedItem.level || 'New');
                            
                            return { 
                                ...item, 
                                level: savedLevel, 
                                correctCount: savedItem.correctCount || 0,
                                failCount: savedItem.failCount || 0
                            };
                        }
                        return item;
                    });
                }
            } catch (e) {
                console.error("Could not load state:", e);
                gameData.forEach(item => { item.level = 'New'; item.correctCount = 0; item.failCount = 0; });
            }
        }

        function saveState() {
            if (!CURRENT_USER_ID) return;
            const STORAGE_KEY = STORAGE_PREFIX + CURRENT_USER_ID;
            try {
                const stateToSave = gameData.map(item => ({
                    term: item.term,
                    level: item.level,
                    correctCount: item.correctCount,
                    failCount: item.failCount || 0
                }));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
                console.log("State saved successfully for " + CURRENT_USER_ID);
            } catch (e) {
                console.error("Could not save state:", e);
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function shuffleString(str) {
            return shuffleArray(str.split('')).join('');
        }

        function initializeData() {
            async function fetchAndParseData() {
                try {
                    const response = await fetch(LIST_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const text = await response.text();
                    const filenames = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

                    gameData = filenames.map(filename => {
                        const cleanName = filename.substring(0, filename.lastIndexOf('.')).replace(/\.(?=[^.]*$)/, '');
                        const firstUnderscoreIndex = cleanName.indexOf('_');
                        
                        let theme = 'Others';
                        let term = cleanName;

                        if (firstUnderscoreIndex !== -1) {
                            theme = cleanName.substring(0, firstUnderscoreIndex).trim().replace(/_/g, ' ');
                            term = cleanName.substring(firstUnderscoreIndex + 1).trim().replace(/_/g, ' ');
                        } else {
                            console.warn(`Filename ${filename} does not contain an underscore. Assigned to 'Others'.`);
                        }
                        
                        if (!theme || theme.length === 0) {
                            theme = 'Others';
                        }

                        const url = BASE_IMAGE_URL + filename;
                        uniqueThemes.add(theme);

                        return {
                            filename,
                            url,
                            theme,
                            term,
                            level: 'New', // Default
                            correctCount: 0,
                            failCount: 0
                        };
                    });
                    
                    totalTerms = gameData.length;
                    switchScreen('login-screen');
                } catch (error) {
                    console.error("Error loading or parsing image list:", error);
                    document.getElementById('loading-screen').innerHTML = `Error loading data: ${error.message}. Check the console for details.`;
                }
            }
            fetchAndParseData();
        }
        
        // --- LOGIN / SESSION MANAGEMENT ---

        function attemptLogin() {
            const selectElement = document.getElementById('username-select');
            const input = selectElement.value.trim();
            const message = document.getElementById('login-message');

            if (VALID_IDS.includes(input)) {
                CURRENT_USER_ID = input;
                loadState(); 
                goToHome();
                message.textContent = "";
                console.warn("PROGRESS NOTE: Progress is saved locally in this browser only. It will not transfer to other devices or browsers.");
            } else {
                message.textContent = `Access denied. Please select a valid name.`;
            }
        }

        function logout() {
            saveState(); 
            CURRENT_USER_ID = null;
            switchScreen('login-screen');
            document.getElementById('login-message').textContent = 'Progress saved.';
        }

        // --- GAME FLOW / NAVIGATION ---

        function goToHome() {
            const greetingElement = document.getElementById('user-greeting');
            const avatarElement = document.getElementById('user-avatar');
            
            greetingElement.textContent = `Hello ${CURRENT_USER_ID}!`;

            if (CURRENT_USER_ID === 'Mikael') {
                avatarElement.src = BASE_IMAGE_URL + "Mikael.png";
                avatarElement.style.display = 'block';
            } else if (CURRENT_USER_ID === 'Marcia') { 
                avatarElement.src = BASE_IMAGE_URL + "Marcia.jpg"; 
                avatarElement.style.display = 'block';
            } else {
                avatarElement.style.display = 'none';
                avatarElement.src = ''; 
            }
            
            updateHomeCounters();
            clearInterval(timer); 
            switchScreen('home-screen');
        }

        // --- HOME SCREEN LOGIC ---

        function updateHomeCounters() {
            const container = document.getElementById('theme-buttons-container');
            container.innerHTML = '';

            const themeCounts = {};
            let intermediateCount = 0;
            let advancedCount = 0;
            let expertCount = 0;
            let masterCount = 0;

            uniqueThemes.forEach(theme => {
                themeCounts[theme] = 0;
            });

            gameData.forEach(item => {
                if (item.level === 'New' && item.theme && item.theme.length > 0) {
                    themeCounts[item.theme] = (themeCounts[item.theme] || 0) + 1;
                } else if (item.level === 'Intermediate') { 
                    intermediateCount++;
                } else if (item.level === 'Advanced') {
                    advancedCount++;
                } else if (item.level === 'Expert') { 
                    expertCount++;
                } else if (item.level === 'Master') { 
                    masterCount++;
                }
            });

            // 3. Inject Theme Buttons (New Level)
            Object.entries(themeCounts)
                .sort(([themeA], [themeB]) => {
                    if (themeA === 'Others') return 1;
                    if (themeB === 'Others') return -1;
                    return themeA.localeCompare(themeB); 
                })
                .forEach(([theme, count]) => {
                    const button = document.createElement('button');
                    button.className = 'theme-button';
                    button.textContent = `${theme} (${count})`;
                    button.onclick = () => startQuiz('New', theme);
                    button.disabled = count === 0; 
                    container.appendChild(button);
                });

            // 4. Add Separator and Level Buttons
            const separator = document.createElement('hr');
            separator.style.margin = '20px 0';
            container.appendChild(separator);

            // Intermediate Button (RENAMED)
            const intermediateButton = document.createElement('button');
            intermediateButton.id = 'intermediate-button';
            intermediateButton.className = 'theme-button medium-button'; 
            intermediateButton.innerHTML = `Intermediate (${intermediateCount}) <i class="fas fa-trophy"></i>`;
            intermediateButton.onclick = () => startQuiz('Intermediate');
            intermediateButton.disabled = intermediateCount === 0;
            container.appendChild(intermediateButton);
            
            // Advanced Button 
            const advancedButton = document.createElement('button');
            advancedButton.id = 'advanced-button';
            advancedButton.className = 'theme-button advanced-button';
            advancedButton.innerHTML = `Advanced (${advancedCount}) <i class="fas fa-trophy"></i><i class="fas fa-trophy"></i>`;
            advancedButton.onclick = () => startQuiz('Advanced');
            advancedButton.disabled = advancedCount === 0;
            container.appendChild(advancedButton);

            // Expert Button (NEW AUDIO GAME LEVEL)
            const expertButton = document.createElement('button');
            expertButton.id = 'expert-button';
            expertButton.className = 'theme-button expert-button'; 
            expertButton.innerHTML = `Expert (${expertCount}) <i class="fas fa-headphones"></i>`;
            expertButton.onclick = () => startQuiz('Expert');
            expertButton.disabled = expertCount === 0;
            container.appendChild(expertButton);


            // Master Button (RENAMED from Expert, Review Level)
            const masterButton = document.createElement('button');
            masterButton.id = 'master-button';
            masterButton.className = 'theme-button expert-button';
            masterButton.innerHTML = `Master (${masterCount}/${totalTerms}) <i class="fas fa-award"></i>`;
            masterButton.onclick = () => startQuiz('Master');
            masterButton.disabled = masterCount === 0;
            container.appendChild(masterButton);
        }

        function resetProgress() {
            showCustomModal();
        }

        // --- QUIZ SETUP AND START ---

        function startQuiz(level, theme = null) {
            currentQuizLevel = level;
            currentQuizTheme = theme;

            quizPool = gameData.filter(item => {
                if (level === 'New') {
                    return item.level === 'New' && item.theme === theme;
                }
                return item.level === level;
            });

            if (quizPool.length === 0) {
                goToHome();
                return;
            }

            quizPool.sort(() => Math.random() - 0.5);
            currentQuizIndex = 0; 
            
            const timerContainer = document.getElementById('timer-container');
            // Only Intermediate level uses the timer
            const timerShouldBeActive = (level === 'Intermediate'); 

            if (timerShouldBeActive) {
                timerContainer.style.display = 'block';
            } else {
                clearInterval(timer); 
                timerContainer.style.display = 'none';
            }

            // Clear choices containers before starting the next question
            document.getElementById('answer-slots-container').innerHTML = '';
            document.getElementById('letter-choices-container').innerHTML = '';
            document.getElementById('choice-buttons-container').innerHTML = '';
            document.getElementById('image-choices-container').innerHTML = '';
            document.getElementById('image-choices-container').style.pointerEvents = 'auto'; // Re-enable interaction

            switchScreen('question-screen');
            loadQuestion();
        }

        // --- QUESTION HANDLING ---

        function loadQuestion() {
            // 1. Filter the quiz pool (to ensure we only quiz on available items)
            quizPool = quizPool.filter(item => {
                const currentState = gameData.find(d => d.term === item.term);
                return currentState && currentState.level === currentQuizLevel && 
                       (currentQuizLevel !== 'New' || currentState.theme === currentQuizTheme);
            });

            if (quizPool.length === 0) {
                goToHome();
                return;
            }

            let itemIndex = currentQuizIndex % quizPool.length;
            currentQuestion = gameData.find(item => item.term === quizPool[itemIndex].term);

            const level = currentQuestion.level;
            const questionImage = document.getElementById('question-image');
            const choiceButtonsContainer = document.getElementById('choice-buttons-container');
            const slotsContainer = document.getElementById('answer-slots-container');
            const letterContainer = document.getElementById('letter-choices-container');
            const imageChoicesContainer = document.getElementById('image-choices-container');
            
            // --- RESET UI ---
            slotsContainer.style.display = 'none';
            letterContainer.style.display = 'none';
            choiceButtonsContainer.style.display = 'none';
            imageChoicesContainer.style.display = 'none';
            questionImage.style.display = 'none'; 

            choiceButtonsContainer.innerHTML = '';
            imageChoicesContainer.innerHTML = '';
            slotsContainer.innerHTML = '';
            letterContainer.innerHTML = '';
            currentAnswer = [];
            
            const refreshButton = document.getElementById('reset-spelling-button');
            const refreshSpacer = document.getElementById('refresh-button-spacer'); 
            refreshButton.style.display = 'none';
            refreshSpacer.style.display = 'block'; 

            // --- RENDER BASED ON LEVEL ---

            if (level === 'Master') { // RENAMED: Master level is now just review
                showMasterReview();
                currentQuizIndex++; 
                currentDistractors = []; 
                return;
            } 
            
            if (level === 'Expert') { // NEW EXPERT LEVEL: Audio Game
                questionImage.style.display = 'none'; 
                imageChoicesContainer.style.display = 'flex'; 
                document.getElementById('quiz-title').textContent = "Listen and identify:";

                renderAudioQuiz(currentQuestion);
                currentDistractors = []; 
                
            } else if (level === 'Advanced') {
                // Advanced Level: Interactive Spelling
                questionImage.style.display = 'block';
                questionImage.src = currentQuestion.url;
                slotsContainer.style.display = 'flex';
                letterContainer.style.display = 'flex';
                document.getElementById('quiz-title').textContent = "Spell the word:";
                refreshButton.style.display = 'block';
                refreshSpacer.style.display = 'none'; 

                renderSpellingGame(currentQuestion);
                currentDistractors = []; 

            } else {
                // New / Intermediate Level: Standard Multiple Choice (Text Buttons)
                questionImage.style.display = 'block';
                questionImage.src = currentQuestion.url;
                choiceButtonsContainer.style.display = 'block';
                document.getElementById('quiz-title').textContent = "What is this?";

                const distractors = getDistractors(level, currentQuestion);
                currentDistractors = distractors; 

                renderQuizChoices(currentQuestion, distractors);
            }

            // Start Timer (Only Intermediate level)
            if (level === 'Intermediate') {
                startTimer();
            } else {
                clearInterval(timer);
            }
            
            currentQuizIndex++; 
            if (currentQuizIndex >= quizPool.length && quizPool.length > 0) {
                quizPool.sort(() => Math.random() - 0.5);
                currentQuizIndex = 0;
            }
            
            switchScreen('question-screen');
        }

        /**
         * NEW FUNCTION: Renders the audio pronunciation quiz (Expert level).
         */
        function renderAudioQuiz(question) {
            const imageChoicesContainer = document.getElementById('image-choices-container');

            // 1. Get 2 Distractors (Must be items with images)
            const distractors = getDistractors(question.level, question, 2); 
            currentDistractors = distractors; 
            const choices = [question, ...distractors];
            shuffleArray(choices); // Randomize image positions

            // 2. Clear and render the choice images
            imageChoicesContainer.innerHTML = '';

            choices.forEach(item => {
                const wrapper = document.createElement('div');
                wrapper.className = 'distractor-item'; 
                wrapper.style.cursor = 'pointer';
                wrapper.style.border = '3px solid var(--color-gray)';
                wrapper.onclick = () => submitAnswer(item, distractors);

                const img = document.createElement('img');
                img.src = item.url;
                img.alt = item.term;
                
                // Add a temporary term for access/logic
                const term = document.createElement('div');
                term.textContent = item.term;
                term.style.display = 'none'; 

                wrapper.appendChild(img);
                wrapper.appendChild(term);
                imageChoicesContainer.appendChild(wrapper);
            });

            // 3. Play the audio immediately upon loading the question
            playAudio(question.term);
            
            // 4. Show the audio button to allow replay
            const audioBtn = document.getElementById('audio-button');
            audioBtn.style.display = 'inline-block';
            audioBtn.onclick = () => playAudio(question.term); 

            // 5. Hide the demote button on the question screen 
            document.getElementById('demote-button').style.display = 'none';
        }

        // --- REST OF THE FUNCTIONS (Updated where necessary) ---

        function getDistractors(level, question, count = 2) {
            const distractors = [];
            let availableTerms = [];
            
            // Expert level needs 2 distractors from Advanced, Intermediate, or New.
            if (level === 'Expert') {
                 availableTerms = gameData.filter(item => 
                     item.term !== question.term && 
                     (item.level === 'Advanced' || item.level === 'Intermediate' || item.level === 'New')
                 );
            } else if (level === 'New') {
                // For 'New', prioritize other 'New' terms within the SAME theme
                availableTerms = gameData.filter(item => 
                    item.level === 'New' && item.theme === question.theme && item.term !== question.term
                );
            } 
            
            // SECONDARY POOL: All 'Intermediate' or 'New' terms globally for Intermediate level.
            if (level === 'Intermediate' || availableTerms.length < count) {
                const globalPool = gameData.filter(item => 
                    item.term !== question.term && (item.level === 'Intermediate' || item.level === 'New')
                );
                
                if (distractors.length > 0) {
                    availableTerms = [...new Set([...availableTerms, ...globalPool])];
                } else {
                     availableTerms = globalPool.slice();
                }
            }
            
            // Draw initial distractors from the available pool
            shuffleArray(availableTerms); 
            
            while (distractors.length < count && availableTerms.length > 0) {
                 const potentialDistractor = availableTerms.shift();
                 if (!distractors.some(d => d.term === potentialDistractor.term)) {
                     distractors.push(potentialDistractor);
                 }
            }

            // TERTIARY POOL: Fallback to ANY other term if still missing distractors
            if (distractors.length < count) {
                const allOtherTerms = gameData.filter(item => item.term !== question.term && 
                                                !distractors.some(d => d.term === item.term));
                shuffleArray(allOtherTerms);
                while (distractors.length < count && allOtherTerms.length > 0) {
                    distractors.push(allOtherTerms.shift());
                }
            }
            return distractors;
        }
        
        /**
         * Renders standard multiple choice buttons (New and Intermediate levels).
         */
        function renderQuizChoices(question, distractors) {
            const choicesContainer = document.getElementById('choice-buttons-container');
            
            const choices = [question, ...distractors];
            shuffleArray(choices); 

            choices.forEach(item => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = item.term;
                button.onclick = () => submitAnswer(item, distractors); 
                choicesContainer.appendChild(button);
            });
        }

        /**
         * Renders the interactive spelling game (Advanced level).
         */
        function renderSpellingGame(question) {
            const slotsContainer = document.getElementById('answer-slots-container');
            const letterContainer = document.getElementById('letter-choices-container');
            
            const cleanTerm = question.term.replace(/\s/g, '').toUpperCase(); 
            correctTermLetters = cleanTerm.split('');

            correctTermLetters.forEach((letter, index) => {
                const slot = document.createElement('div');
                slot.className = 'letter-slot';
                slot.id = `slot-${index}`;
                slotsContainer.appendChild(slot);
            });

            const shuffledLetters = shuffleArray(correctTermLetters.slice()); 
            
            shuffledLetters.forEach((letter, index) => {
                const button = document.createElement('button');
                button.className = 'letter-button';
                button.textContent = letter;
                button.dataset.letter = letter;
                button.dataset.index = index; 
                button.onclick = () => clickLetter(button);
                letterContainer.appendChild(button);
            });
        }
        
        function resetSpelling() {
            document.querySelectorAll('#letter-choices-container .letter-button').forEach(btn => {
                btn.disabled = false;
            });
            
            document.querySelectorAll('#answer-slots-container .letter-slot').forEach(slot => {
                slot.textContent = '';
                slot.style.color = 'var(--color-text)';
                slot.style.borderBottomColor = 'var(--color-text)'; 
            });
            currentAnswer = [];
            
            document.getElementById('reset-spelling-button').style.display = 'block'; 
            document.getElementById('refresh-button-spacer').style.display = 'none';

        }

        function clickLetter(button) {
            const slots = document.getElementById('answer-slots-container').children;
            const currentIndex = currentAnswer.length;

            if (currentIndex < correctTermLetters.length) {
                const letter = button.dataset.letter;
                
                slots[currentIndex].textContent = letter;
                currentAnswer.push(letter);
                
                button.disabled = true;
                
                if (currentAnswer.length === correctTermLetters.length) {
                    document.getElementById('reset-spelling-button').style.display = 'none';
                    document.getElementById('refresh-button-spacer').style.display = 'block'; 
                    
                    clearInterval(timer);
                    checkAnswer();
                }
            }
        }

        function checkAnswer() {
            const userAnswer = currentAnswer.join('');
            const correctAnswer = correctTermLetters.join('');
            const isCorrect = userAnswer === correctAnswer;
            
            const slots = document.getElementById('answer-slots-container').children;
            for(let i = 0; i < slots.length; i++) {
                slots[i].style.color = isCorrect ? 'var(--color-secondary)' : 'var(--color-wrong)';
                slots[i].style.borderBottomColor = isCorrect ? 'var(--color-secondary)' : 'var(--color-wrong)';
            }

            submitAnswer(isCorrect ? currentQuestion : null, []); 
        }

        /**
         * NEW FUNCTION: Master level is now the review screen.
         */
        function showMasterReview() {
            clearInterval(timer);
            
            document.getElementById('feedback-message').textContent = "Review: Master";
            document.getElementById('feedback-message').className = 'feedback-message';

            document.getElementById('question-feedback-image').src = currentQuestion.url;
            document.getElementById('question-feedback-image').style.display = 'block';
            document.getElementById('question-feedback-term').textContent = currentQuestion.term;
            
            document.querySelector('.distractor-details').style.display = 'none';
            document.querySelector('.continue-button-container').style.display = 'block';

            const demoteBtn = document.getElementById('demote-button');
            demoteBtn.style.display = 'block';
            demoteBtn.textContent = "Demote to Expert"; 

            switchScreen('feedback-screen');
        }

        function startTimer() {
            clearInterval(timer);
            const totalTime = MEDIUM_TIMER_SECONDS * 1000;
            let timeRemaining = totalTime;
            const bar = document.getElementById('timer-bar');

            bar.style.width = '100%';

            timer = setInterval(() => {
                timeRemaining -= 100;
                const percentage = (timeRemaining / totalTime) * 100;
                bar.style.width = percentage + '%';

                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    document.querySelectorAll('.letter-button, .choice-button, #image-choices-container .distractor-item').forEach(btn => btn.style.pointerEvents = 'none');
                    
                    document.getElementById('reset-spelling-button').style.display = 'none'; 
                    document.getElementById('refresh-button-spacer').style.display = 'block'; 

                    if (currentQuizLevel === 'Intermediate') {
                        submitAnswer(null, currentDistractors); 
                    }
                }
            }, 100);
        }

        function submitAnswer(chosenItem, distractors) {
            clearInterval(timer);
            
            // Disable all buttons/interactions immediately after submission
            document.querySelectorAll('.letter-button, .choice-button, #image-choices-container .distractor-item').forEach(btn => btn.style.pointerEvents = 'none');
            
            document.getElementById('reset-spelling-button').style.display = 'none';
            document.getElementById('refresh-button-spacer').style.display = 'block';

            const isCorrect = chosenItem && chosenItem.term === currentQuestion.term;
            
            // Highlight chosen image for Expert level feedback
            if (currentQuizLevel === 'Expert') {
                document.querySelectorAll('#image-choices-container .distractor-item').forEach(item => {
                    const termElement = item.querySelector('div');
                    const isThisItem = termElement.textContent === chosenItem.term;
                    
                    if (isThisItem) {
                        item.style.border = `3px solid ${isCorrect ? 'var(--color-secondary)' : 'var(--color-wrong)'}`;
                    } else if (termElement.textContent === currentQuestion.term) {
                        // Highlight the correct answer if the user was wrong
                        if (!isCorrect) {
                            item.style.border = '3px solid var(--color-secondary)';
                        }
                    }
                });
            }
            
            const oldLevel = currentQuestion.level; 
            
            processProgress(isCorrect);
            
            const updatedItem = gameData.find(d => d.term === currentQuestion.term);
            const newLevel = updatedItem ? updatedItem.level : oldLevel;
            
            if (isCorrect && oldLevel !== newLevel) {
                 PROMOTION_INFO = { oldLevel: oldLevel, newLevel: newLevel };
            } else {
                 PROMOTION_INFO = null;
            }

            showFeedback(isCorrect, currentQuestion, distractors, chosenItem);

            saveState(); 
        }

        // --- PROGRESS MANAGEMENT (MODIFIED to use new level names) ---

        function processProgress(isCorrect) {
            const item = currentQuestion;
            const currentLevel = item.level;

            if (isCorrect) {
                item.correctCount++;
                item.failCount = 0; 
                
                if (currentLevel === 'New' && item.correctCount >= LEVELS.New.count) {
                    item.level = LEVELS.New.promoteTo; 
                    item.correctCount = 0;
                } else if (currentLevel === 'Intermediate' && item.correctCount >= LEVELS.Intermediate.count) {
                    item.level = LEVELS.Intermediate.promoteTo; 
                    item.correctCount = 0;
                } else if (currentLevel === 'Advanced' && item.correctCount >= LEVELS.Advanced.count) {
                    item.level = LEVELS.Advanced.promoteTo; 
                    item.correctCount = 0;
                } else if (currentLevel === 'Expert' && item.correctCount >= LEVELS.Expert.count) {
                    item.level = LEVELS.Expert.promoteTo; 
                    item.correctCount = 0;
                }
            } else {
                item.correctCount = 0; 
                
                if (currentLevel === 'Advanced') {
                    item.failCount = (item.failCount || 0) + 1; 
                    
                    if (item.failCount >= 3) {
                        item.level = LEVELS.Advanced.demoteTo; 
                        item.failCount = 0;
                    }
                } else if (currentLevel === 'Expert') { 
                    item.failCount = (item.failCount || 0) + 1; 
                    
                    if (item.failCount >= 3) {
                        item.level = LEVELS.Expert.demoteTo; 
                        item.failCount = 0;
                    }
                } else {
                    item.failCount = 0;
                }
            }
            // Update the main gameData array
            const index = gameData.findIndex(d => d.term === item.term);
            if (index !== -1) {
                gameData[index].level = item.level;
                gameData[index].correctCount = item.correctCount;
                gameData[index].failCount = item.failCount || 0; 
            }
        }
        
        // --- DEMOTION LOGIC (MODIFIED to use new level names) ---

        function demoteTerm() {
            const item = currentQuestion;
            
            if (item.level === 'Master') {
                item.level = 'Expert'; 
            } else if (item.level === 'Expert') {
                item.level = 'Advanced'; 
            } else if (item.level === 'Advanced') {
                item.level = 'Intermediate'; 
            } else if (item.level === 'Intermediate') {
                item.level = 'New'; 
            }
            
            const index = gameData.findIndex(d => d.term === item.term);
            if (index !== -1) {
                gameData[index].level = item.level;
                gameData[index].correctCount = 0;
                gameData[index].failCount = 0; 
            }

            saveState();
            goToHome(); 
        }

        // --- AUDIO/TTS FUNCTIONALITY (MODIFIED) ---

        /**
         * Uses the Web Speech API (if supported) to pronounce the current term.
         */
        function playAudio(termToSpeak) {
            const textToSpeak = termToSpeak || (currentQuestion ? currentQuestion.term : ''); 
            
            if (!textToSpeak) return;

            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                
                utterance.lang = 'en-US'; 
                
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
                
                console.log(`Speaking: ${textToSpeak}`);
            } else {
                alert("Text-to-Speech is not supported in this browser.");
                console.error("SpeechSynthesis API not available.");
            }
        }

        // --- FEEDBACK SCREEN (MODIFIED for Expert level) ---

        function showFeedback(isCorrect, question, distractors, chosenItem) {
            
            const messageElement = document.getElementById('feedback-message');
            const iconClass = isCorrect ? 'fas fa-face-grin-stars' : 'fas fa-meh-rolling-eyes'; 
            let messageText = isCorrect ? "You are right!" : "You are wrong!";
            
            if (currentQuizLevel === 'Expert') {
                messageText = isCorrect ? "Correct identification!" : "Incorrect identification!";
            }
            
            messageElement.innerHTML = `${messageText} <i class="${iconClass}"></i>`;
            messageElement.className = `feedback-message ${isCorrect ? 'feedback-correct' : 'feedback-wrong'}`;

            if (!isCorrect && !chosenItem && currentQuizLevel === 'Intermediate') {
                messageElement.innerHTML = `Time's up! <i class="${iconClass}"></i>`;
            }

            // 2. Question Detail 
            document.getElementById('question-feedback-image').src = question.url;
            document.getElementById('question-feedback-image').style.display = 'block';
            document.getElementById('question-feedback-term').textContent = question.term;
            
            // 3. Audio Button Visibility
            const audioBtn = document.getElementById('audio-button');
            
            if (currentQuizLevel === 'New' || currentQuizLevel === 'Intermediate' || currentQuizLevel === 'Expert') {
                audioBtn.style.display = 'inline-block';
                audioBtn.onclick = () => playAudio(question.term); 
            } else {
                audioBtn.style.display = 'none';
            }

            // 4. Demote Button
            const demoteBtn = document.getElementById('demote-button');
            const updatedItem = gameData.find(d => d.term === question.term);
            const updatedLevel = updatedItem ? updatedItem.level : question.level;
            
            if (updatedLevel === 'Master') {
                demoteBtn.style.display = 'block';
                demoteBtn.textContent = "Demote to Expert";
            } else if (updatedLevel === 'Expert' && !isCorrect) {
                 demoteBtn.style.display = 'block';
                 demoteBtn.textContent = "Study this again (Demote to Advanced)";
            } else if (updatedLevel === 'Advanced' && !isCorrect) {
                 demoteBtn.style.display = 'block';
                 demoteBtn.textContent = "Study this again (Demote to Intermediate)";
            } else if (updatedLevel === 'Intermediate' && !isCorrect) {
                 demoteBtn.style.display = 'block';
                 demoteBtn.textContent = "Study this again (Demote to New)";
            } else {
                 demoteBtn.style.display = 'none';
            }
            
            // 5. Distractor Details 
            const distractorDetailsContainer = document.querySelector('.distractor-details');
            document.querySelector('.continue-button-container').style.display = 'block';
            
            const imageChoicesContainer = document.getElementById('image-choices-container');
            imageChoicesContainer.style.display = 'none';
            
            if (currentQuizLevel === 'New' || currentQuizLevel === 'Intermediate') {
                distractorDetailsContainer.style.display = 'flex';
                
                const relevantDistractors = distractors; 

                document.getElementById('distractor1-image').src = relevantDistractors[0] ? relevantDistractors[0].url : '';
                document.getElementById('distractor1-term').textContent = relevantDistractors[0] ? relevantDistractors[0].term : '';
                document.querySelector('.distractor-item:nth-child(1)').style.display = relevantDistractors[0] ? 'block' : 'none';
                
                document.getElementById('distractor2-image').src = relevantDistractors[1] ? relevantDistractors[1].url : '';
                document.getElementById('distractor2-term').textContent = relevantDistractors[1] ? relevantDistractors[1].term : '';
                document.querySelector('.distractor-item:nth-child(2)').style.display = relevantDistractors[1] ? 'block' : 'none';

            } else {
                 distractorDetailsContainer.style.display = 'none';
            }

            // 6. Promotion Message Display
            const promotionMessageElement = document.getElementById('promotion-message');
            if (PROMOTION_INFO) {
                const { newLevel } = PROMOTION_INFO;
                let messagePrefix = "Well done! This term goes to the";
                
                if (newLevel === 'Master') {
                    messagePrefix = "You rock! This term goes to the";
                }

                promotionMessageElement.textContent = `${messagePrefix} ${newLevel} level`;
                promotionMessageElement.style.display = 'block';

                PROMOTION_INFO = null;
            } else {
                promotionMessageElement.style.display = 'none';
                promotionMessageElement.textContent = '';
            }
            
            switchScreen('feedback-screen');
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Display loading screen immediately
            document.getElementById('loading-screen').style.display = 'flex';
            document.getElementById('loading-screen').classList.add('active');

            initializeData();
        });
    </script>
</body>
</html>
